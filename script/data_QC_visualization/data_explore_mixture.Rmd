---
title: "basic data exploreation"
output: html_notebook
---


Overall experiment design:

* The gene counting matrix and SCE object were created by `scPipe` package.
* The data already passed through quality control filter, using `detect_outlier` in `scPipe` with `comp=2`.

```{r label, out.width = "85%", fig.cap = "caption"}
knitr::include_graphics("mRNAmix_9cell_design.pdf")
```

```{r,warning=FALSE,message=FALSE}
library(scran)
library(scater)
library(ggplot2)
library(DT)
load("~/git/CellBench_data/data/mRNAmix_qc.RData") # change to your own path
load("~/git/CellBench_data/data/9cellmix_qc.RData") # change to your own path
```

# A. RNA mixture

* `sce2_qc` were generated by CEL-seq2 protocol and `sce8_qc` were generated by Sort-seq protocol.

## metadata

### RNAmixture CEL-seq2 (sce2)

```{r}
datatable(as.data.frame(colData(sce2_qc)),width=800,options=list(scrollX= TRUE))
```

### RNAmixture Sort-seq (sce8)

```{r}
datatable(as.data.frame(colData(sce8_qc)),width=800,options=list(scrollX= TRUE))
```

## data normalization

```{r}
sce2_qc <- computeSumFactors(sce2_qc)
sce2_qc <- normalize(sce2_qc)

sce8_qc <- computeSumFactors(sce8_qc)
sce8_qc <- normalize(sce8_qc)
```

## visualization

### sce2


```{r}
sce2_qc$mix = as.factor(sce2_qc$mix)
plotPCA(sce2_qc,ncomponents = 3,colour_by = "mix")
```

### sce8


```{r}
sce8_qc$mix = as.factor(sce8_qc$mix)
plotPCA(sce8_qc,ncomponents = 3,colour_by = "mix")
```

## data integration using mutual nearest neighbours (MNN)

following the tutorial: http://bioconductor.org/packages/3.7/workflows/vignettes/simpleSingleCell/inst/doc/work-5-mnn.html

```{r}
scran_high_var = function(sce,topn=1000){
  var.fit <- trendVar(sce, method="loess", use.spikes=FALSE)
  var.out <- decomposeVar(sce, var.fit)
  hvg.out <- var.out[order(var.out$bio, decreasing=TRUE)[1:topn], ]
  return(rownames(hvg.out))
}

high_var_sce2 = scran_high_var(sce2_qc)
high_var_sce8 = scran_high_var(sce8_qc)
high_var_genes = intersect(high_var_sce2, high_var_sce8)
```


```{r}
colnames(sce8_qc) = paste0("sce8_",colnames(sce8_qc)) # aviod duplicated col names

corrected = mnnCorrect(logcounts(sce2_qc)[high_var_genes,], logcounts(sce8_qc)[high_var_genes,])
colnames(corrected$corrected[[2]]) = colnames(sce8_qc)

sce_merge = SingleCellExperiment(assays=list(counts=cbind(counts(sce2_qc)[high_var_genes,],
                                                          counts(sce8_qc)[high_var_genes,]), 
                                             logcounts=cbind(logcounts(sce2_qc)[high_var_genes,],
                                                             logcounts(sce8_qc)[high_var_genes,]),
                                             corrected_logcounts=cbind(corrected$corrected[[1]],corrected$corrected[[2]])))
sce_merge$batch = c(rep("CEL-seq2",ncol(sce2_qc)),rep("Sort-seq",ncol(sce8_qc)))

```

PCA

```{r,fig.height=4,fig.width=10}
before = plotPCA(sce_merge,ncomponents = 3,run_args=list("exprs_values"="logcounts","feature_set" = high_var_genes),colour_by = "batch")+ggtitle("Before correction")
after = plotPCA(sce_merge,ncomponents = 3,run_args=list("exprs_values"="corrected_logcounts","feature_set" = high_var_genes),colour_by = "batch")+ggtitle("After correction")
multiplot(before, after, cols=2)
```

t-SNE

```{r,fig.height=4,fig.width=10}
before = plotTSNE(sce_merge,ncomponents = 2,run_args=list("exprs_values"="logcounts","feature_set" = high_var_genes),colour_by = "batch")+ggtitle("Before correction")
after = plotTSNE(sce_merge,ncomponents = 2,run_args=list("exprs_values"="corrected_logcounts","feature_set" = high_var_genes),colour_by = "batch")+ggtitle("After correction")
multiplot(before, after, cols=2)
```


# B. 9 cell mixture

* `sce_SC1_qc` to `sce_SC4_qc` were subsampled from the same pool of samples, from one 384-plate. `1/9` of the total sample were sampled to `SC1`, `SC2` and `SC3` and the PCR product clean up ratio were 0.7, 0.8, 0.9 correspondingly. `1/3` of the total sample were taken in `SC4`. We use `SC3` as the representative dataset in following analysis.

## metadata

```{r}
datatable(as.data.frame(colData(sce_SC3_qc)),width=800,options=list(scrollX= TRUE))
```

## data normalization

```{r}
sce_SC3_qc <- computeSumFactors(sce_SC3_qc)
sce_SC3_qc <- normalize(sce_SC3_qc)
```

## visualization

```{r}
sce_SC3_qc$group = paste(colData(sce_SC3_qc)$H2228,
                         colData(sce_SC3_qc)$H1975,
                         colData(sce_SC3_qc)$HCC827,sep="_")
plotPCA(sce_SC3_qc,ncomponents = 3,colour_by = "group")
```

select the major trajectory

```{r}
sce_SC3_qc_traj = sce_SC3_qc[,colData(sce_SC3_qc)$traj =="YES"]

high_var_SC3 = scran_high_var(sce_SC3_qc_traj)

sce_SC3_qc_traj = runPCA(sce_SC3_qc_traj,run_args=list("feature_set" = high_var_SC3))
plotPCA(sce_SC3_qc_traj,colour_by = "group")
```

## build trajectory using `slingshot`

```{r,message=FALSE,warning=FALSE}
library(slingshot)
library(RColorBrewer)
num_k=7
kmeans_clu = kmeans(SingleCellExperiment::reducedDim(sce_SC3_qc_traj,"PCA"),centers=num_k)
slingshot_lin = getLineages(SingleCellExperiment::reducedDim(sce_SC3_qc_traj,"PCA"),kmeans_clu$cluster)
slingshot_crv = getCurves(slingshot_lin)
slingshot_pseudo = pseudotime(slingshot_crv)

```


```{r}
plot(SingleCellExperiment::reducedDim(sce_SC3_qc_traj,"PCA"), col = brewer.pal(num_k,"Set1")[kmeans_clu$cluster], asp = 1, pch = 16)
lines(slingshot_lin, lwd = 3)
```


```{r}
plot(SingleCellExperiment::reducedDim(sce_SC3_qc_traj,"PCA"), col = brewer.pal(num_k,"Set1")[kmeans_clu$cluster], asp = 1, pch = 16)
lines(slingshot_crv, lwd = 3)
```

