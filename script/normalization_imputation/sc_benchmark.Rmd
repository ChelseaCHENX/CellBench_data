---
title: "single cell benchmark"
output: html_notebook
---

# Preparation

Load some packages

```{r message=FALSE}
library(scran)
library(scater)
library(ggplot2)
library(edgeR)
library(DESeq)
# library(ggridges)
```

Load R data

```{r}
# load("SCE_sc.RData")
load("SCE_sc_newQC.RData")
```

Assign cell line information and check

<!-- ```{r} -->
<!-- # sce10x_qc$cell_line <- sce10x_qc_sel$cell_line -->
<!-- # sce4_qc$cell_line <- sce4_qc_sel$cell_line -->
<!-- # sce701_qc$cell_line <- sce701_qc_sel$cell_line -->

<!-- table(sce4_qc$cell_line) -->
<!-- table(sce10x_qc$cell_line) -->
<!-- table(sce701_qc$cell_line) -->
<!-- ``` -->

```{r}
demuxlet <- read.delim("NN84_RPI4_demuxlet.best")
index_anno <- read.csv("/wehisan/general/user_managed/grpu_naik.s_1/NN45_18.05.17/barcode_annotation.csv")
index_anno_alter <- index_anno
# use N instead of C or G for the end of barcode
index_anno_alter$index <- sub("C$", "N", index_anno$index)
index_anno_alter$index <- sub("G$", "N", index_anno_alter$index)
demuxlet_match <- merge(index_anno_alter, demuxlet,  by.y = "BARCODE", by.x = "index", all.x = TRUE)
# what we do now: use NN instead of CN or GN, combine the results, delete the rows with total read < 500
index_anno_alter$index <- sub("GN$", "NN", index_anno_alter$index)
index_anno_alter$index <- sub("CN$", "NN", index_anno_alter$index)
demuxlet_match2 <- merge(index_anno_alter, demuxlet,  by.y = "BARCODE", by.x = "index", all.x = TRUE)
# get the lines end with NN
demuxlet_match2 <- demuxlet_match2[grepl("NN$", demuxlet_match2$index),]
demuxlet_match <- rbind(demuxlet_match, demuxlet_match2)
demuxlet_match <- demuxlet_match[demuxlet_match$RD.TOTL >= 500,]

sce4_qc$samplename <- colnames(sce4_qc)
cell_line <- merge(demuxlet_match[, c("SNG.1ST", "samplename")], data.frame(colData(sce4_qc)), by = "samplename")

sce4_qc$cell_line <- demuxlet_match[match(colnames(sce4_qc), demuxlet_match$samplename ), "SNG.1ST"]
```

<!--
```{r}
cor_sc_within <- function(sce, norm_assay = "norm_exprs") {
  cor_val = c()
  cell = c()
  norm_mat = assay(sce, norm_assay)
  for(cell_line in c("H1975", "H2228", "HCC827")){
    sel_cell = colData(sce)$cell_line == cell_line
    cor_mat = cor(norm_mat[,sel_cell])
    cor_mat[!lower.tri(cor_mat)] = NA
    cor_mat = as.numeric(cor_mat)
    cor_mat = cor_mat[!is.na(cor_mat)]
    cor_val = c(cor_val, cor_mat)
    cell = c(cell, rep(cell_line, length(cor_mat)))
  }
  res_df = data.frame(cor_val = cor_val, cell_line = cell)
}
```
-->

Function for calculate silhouette width of PCA analysis, group samples according to their cell type

```{r}
library(cluster)

calcSilhouette <- function(SCE, name){
  sil <- silhouette(as.numeric(factor(SCE$cell_line)), dist(reducedDim(SCE)))
  sil <- data.frame(sil[1:nrow(sil),])
  method <- rep(name, nrow(sil))
  sil <- cbind(sil, method)
}
```

Function for subsample of a specific cell line (reduce the number of cells of a specific cell line)
useful for test whether algorithms are robust and preserve rare cell type

```{r}
subsample_cell <- function(SCE, cell_line, proportion){
  cells <- which(SCE$cell_line == cell_line)
  delete_n <- length(cells) * (1 - proportion) # number of cells to be deleted
  delete_cell <- sample(cells, delete_n)
  SCE_return <- SCE[,-delete_cell]
  assays(SCE_return) <- list(counts = counts(SCE_return)) # delete useless assays to reduce its size
  return (SCE_return)
}
```

Reduce the number of cells (not caring which cell line) and reture an SCE with raw count

```{r}
subsample <- function(SCE, proportion = 0.5){
  remain_cell <- sample(ncol(SCE), ncol(SCE) * proportion)
  SCE_return <- SCE[,remain_cell]
  assays(SCE_return) <- list(counts = counts(SCE_return))
  return(SCE_return)
}
```



# Benchmarking for normalization methods

initialize time data frame
```{r}
# norm_time <- data.frame()
```


## raw log count

```{r}
#time1 <- Sys.time()
time_raw <- system.time(
logcounts(sce4_qc) <- log2(counts(sce4_qc) + 1))
#time2 <- Sys.time()
#time_raw <- c("logcounts", time2 - time1)
#colnames(norm_time) <- c("methods", "time")
# cor_df_raw = cor_sc_within(sce4_qc, "logcounts")
# ggplot(data = cor_df_raw, aes(x = factor(cell_line), y = cor_val, fill = factor(cell_line))) + geom_violin()
```

## log cpm

```{r}
#time1 <- Sys.time()
time_CPM <- system.time(
{assay(sce4_qc, "norm_cpm") = log2(cpm(counts(sce4_qc)) + 1)})
#time2 <- Sys.time()
#time_CPM <- c( "logCPM", time2 - time1)

# cor_df_cpm = cor_sc_within(sce4_qc, "norm_cpm")
# ggplot(data = cor_df_cpm, aes(x = factor(cell_line), y = cor_val, fill = factor(cell_line))) + geom_violin()
```

## scran

```{r}
#time1 <- Sys.time()
time_scran <- system.time({
  sce4_qc <- computeSumFactors(sce4_qc)
  sce4_qc <- normalise(sce4_qc)
  assay(sce4_qc, "scran") = logcounts(sce4_qc)
})
#time2 <- Sys.time()
#time_scran <- c("scran", time2 - time1)
# cor_df_scran = cor_sc_within(sce4_qc, "scran")
# ggplot(data = cor_df_scran, aes(x = factor(cell_line), y = cor_val, fill = factor(cell_line))) + geom_violin()
```

## TMM from edgeR

```{r}
#time1 <- Sys.time()
time_TMM <- system.time({
  sizeFactors(sce4_qc) <- calcNormFactors(counts(sce4_qc), method = "TMM")
  sce4_qc <- normalise(sce4_qc)
  assay(sce4_qc, "TMM") <- logcounts(sce4_qc)
})
#time2 <- Sys.time()
#time_TMM <- c("TMM", time2 - time1)
# cor_df_TMM <- cor_sc_within(sce4_qc, "TMM")
# ggplot(data = cor_df_TMM, aes(x = factor(cell_line), y = cor_val, fill = factor(cell_line))) + geom_violin()

```

## DESeq

```{r}
#time1 <- Sys.time()
time_DESeq <- system.time({
  sizeFactors(sce4_qc) <- estimateSizeFactorsForMatrix(counts(sce4_qc))
  sce4_qc <- normalize(sce4_qc)
  assay(sce4_qc, "DESeq") <- logcounts(sce4_qc)
})
#time2 <- Sys.time()
#time_DESeq <- c("DESeq", time2 - time1)
# cor_df_DESeq <- cor_sc_within(sce4_qc, "DESeq")
# ggplot(data = cor_df_DESeq, aes(x = factor(cell_line), y = cor_val, fill = factor(cell_line))) + geom_violin()
detach("package:DESeq", unload=TRUE) 
```



## SCnorm

```{r}
library(SCnorm)
#time1 <- Sys.time()
time_SCnorm <- system.time({
  SCnorm_out <- SCnorm(Data = counts(sce4_qc), Conditions = as.numeric(factor(sce4_qc$cell_line)), PrintProgressPlots = T)
  # load("SCnorm_out.RData")
  
  assay(sce4_qc, "SCnorm") = log2(metadata(SCnorm_out)$NormalizedData + 1)
  #time2 <- Sys.time()
  #time_SCnorm <- c("SCnorm", time2 - time1)
})
save(SCnorm_out, file = "SCnorm_out_new.RData")

# cor_df_SCnorm <- cor_sc_within(sce4_qc, "SCnorm")
# ggplot(data = cor_df_SCnorm, aes(x = factor(cell_line), y = cor_val, fill = factor(cell_line))) + geom_violin()

detach("package:SCnorm", unload=TRUE) 
```

## knn

test the influence of different k value
```{r}
source("/wehisan/home/allstaff/d/dong.x/mixture/knn-smoothing-master/knn_smooth.R")
#time1 <- Sys.time()
time_knn1 <- system.time({
sce4_smoothed = knn_smoother(counts(sce4_qc), k = 1)
assay(sce4_qc, "knn1") = log2(sce4_smoothed + 1)
})
# time2 <- Sys.time()
# time_knn1 <- c("knn1", time2 - time1)

# time1 <- Sys.time()
time_knn3 <- system.time({
sce4_smoothed = knn_smoother(counts(sce4_qc), k = 3)
assay(sce4_qc, "knn3") = log2(sce4_smoothed + 1)
})
# time2 <- Sys.time()
# time_knn3 <- c("knn3", time2 - time1)

# time1 <- Sys.time()
time_knn7 <- system.time({
sce4_smoothed = knn_smoother(counts(sce4_qc), k = 7)
assay(sce4_qc, "knn7") = log2(sce4_smoothed + 1)
})
# time2 <- Sys.time()
# time_knn7 <- c("knn7", time2 - time1)

# time1 <- Sys.time()
time_knn15 <- system.time({
sce4_smoothed = knn_smoother(counts(sce4_qc), k = 15)
assay(sce4_qc, "knn15") = log2(sce4_smoothed + 1)
})
# time2 <- Sys.time()
# time_knn15 <- c("knn15", time2 - time1)

# time1 <- Sys.time()
time_knn31 <- system.time({
sce4_smoothed = knn_smoother(counts(sce4_qc), k = 31)
assay(sce4_qc, "knn31") = log2(sce4_smoothed + 1)
})
# time2 <- Sys.time()
# time_knn31 <- c("knn31", time2 - time1)

# time1 <- Sys.time()
time_knn63 <- system.time({
sce4_smoothed = knn_smoother(counts(sce4_qc), k = 63)
assay(sce4_qc, "knn63") = log2(sce4_smoothed + 1)
})
# time2 <- Sys.time()
# time_knn63 <- c("knn63", time2 - time1)

# time1 <- Sys.time()
time_knn127 <- system.time({
sce4_smoothed = knn_smoother(counts(sce4_qc), k = 127)
assay(sce4_qc, "knn127") = log2(sce4_smoothed + 1)
})
# time2 <- Sys.time()
# time_knn127 <- c("knn127", time2 - time1)

# time1 <- Sys.time()
time_knn255 <- system.time({
sce4_smoothed = knn_smoother(counts(sce4_qc), k = 255)
assay(sce4_qc, "knn255") = log2(sce4_smoothed + 1)
})
# time2 <- Sys.time()
# time_knn255 <- c("knn255", time2 - time1)
```


```{r}
k1 <- runPCA(sce4_qc, exprs_values = "knn1")
k3 <- runPCA(sce4_qc, exprs_values = "knn3")
k7 <- runPCA(sce4_qc, exprs_values = "knn7")
k15 <- runPCA(sce4_qc, exprs_values = "knn15")
k31 <- runPCA(sce4_qc, exprs_values = "knn31")
k63 <- runPCA(sce4_qc, exprs_values = "knn63")
k127 <- runPCA(sce4_qc, exprs_values = "knn127")
k255 <- runPCA(sce4_qc, exprs_values = "knn255")

PCAk1 <- plotPCASCE(k1, colour_by = "cell_line", exprs_values = "knn1", ncomponents = 2) + ggtitle("k = 1")+ theme(legend.position="none")
PCAk3 <- plotPCASCE(k3, colour_by = "cell_line", exprs_values = "knn3", ncomponents = 2) + ggtitle("k = 3")+ theme(legend.position="none")
PCAk7 <- plotPCASCE(k7, colour_by = "cell_line", exprs_values = "knn7", ncomponents = 2) + ggtitle("k = 7")+ theme(legend.position="none")
PCAk15 <- plotPCASCE(k15, colour_by = "cell_line", exprs_values = "knn15", ncomponents = 2) + ggtitle("k = 15")+ theme(legend.position="none")
PCAk31 <- plotPCASCE(k31, colour_by = "cell_line", exprs_values = "knn31", ncomponents = 2) + ggtitle("k = 31")+ theme(legend.position="none")
PCAk63 <- plotPCASCE(k63, colour_by = "cell_line", exprs_values = "knn63", ncomponents = 2) + ggtitle("k = 63")+ theme(legend.position="none")
PCAk127 <- plotPCASCE(k127, colour_by = "cell_line", exprs_values = "knn127", ncomponents = 2) + ggtitle("k = 127")+ theme(legend.position="none")
PCAk255 <- plotPCASCE(k255, colour_by = "cell_line", exprs_values = "knn255", ncomponents = 2) + ggtitle("k = 255")+ theme(legend.position="none")
save(PCAk1, PCAk3, PCAk7, PCAk15, PCAk31, PCAk63, PCAk127, PCAk255, file = "pca_knn.RData")
multiplot(PCAk1, PCAk3, PCAk7, PCAk15, PCAk31, PCAk63, PCAk127, PCAk255, cols=3)
```
```{r}
# PCAk1 <- plotPCASCE(k1, colour_by = "cell_line", exprs_values = "knn1", ncomponents = 2) + theme(legend.position="none")
# PCAk3 <- plotPCASCE(k3, colour_by = "cell_line", exprs_values = "knn3", ncomponents = 2) + theme(legend.position="none")
# PCAk7 <- plotPCASCE(k7, colour_by = "cell_line", exprs_values = "knn7", ncomponents = 2) +  theme(legend.position="none")
# PCAk15 <- plotPCASCE(k15, colour_by = "cell_line", exprs_values = "knn15", ncomponents = 2) +  theme(legend.position="none")
# PCAk31 <- plotPCASCE(k31, colour_by = "cell_line", exprs_values = "knn31", ncomponents = 2) +  theme(legend.position="none")
# PCAk63 <- plotPCASCE(k63, colour_by = "cell_line", exprs_values = "knn63", ncomponents = 2) +  theme(legend.position="none")
# PCAk127 <- plotPCASCE(k127, colour_by = "cell_line", exprs_values = "knn127", ncomponents = 2) +  theme(legend.position="none")
# PCAk255 <- plotPCASCE(k255, colour_by = "cell_line", exprs_values = "knn255", ncomponents = 2) +  theme(legend.position="none")
# save(PCAk1, PCAk3, PCAk7, PCAk15, PCAk31, PCAk63, PCAk127, PCAk255, file = "pca_knn.RData")
```

```{r}
sil_k1 <- calcSilhouette(k1, "kNN (k=1)")
sil_k3 <- calcSilhouette(k3, "kNN (k=3)")
sil_k7 <- calcSilhouette(k7, "kNN (k=7)")
sil_k15 <- calcSilhouette(k15, "kNN (k=15)")
sil_k31 <- calcSilhouette(k31, "kNN (k=31)")
sil_k63 <- calcSilhouette(k63, "kNN (k=63)")
sil_k127 <- calcSilhouette(k127, "kNN (k=127)")
sil_k255 <- calcSilhouette(k255, "kNN (k=255)")

sil_knn <- rbind(sil_k1, sil_k3, sil_k7, sil_k15, sil_k31, sil_k63, sil_k127, sil_k255)
ggplot(sil_knn, aes(x = method, y = sil_width, fill = factor(cluster))) + geom_boxplot() + theme_bw()
ggplot(sil_knn, aes(x = method, y = sil_width, fill = method)) + geom_boxplot() + theme_bw()
```




## BASiCS

```{r}
# library(BASiCS)
# # sce4_qc$cell_line <- sce4_qc_sel$cell_line
# sce4_qc_B <- sce4_qc
# # time1 <- Sys.time()
# time_BASiCS <- system.time({
# sce4_qc_B <- sce4_qc_B[!grepl("^Gm",rownames(sce4_qc_B)),]
# sce4_qc_B <- sce4_qc_B[!grepl("^Rpl", rownames(sce4_qc_B)),]
# sce4_qc_B <- sce4_qc_B[!grepl("^Rps", rownames(sce4_qc_B)),]
# sce4_qc_B <- sce4_qc_B[!grepl("^mt-", rownames(sce4_qc_B)),]
# sce4_qc_B <- sce4_qc_B[order(isSpike(sce4_qc_B)),]
# 
# cms_095046 <- read.delim("cms_095046.txt", stringsAsFactors = FALSE)
# 
# #hist(counts(sce4_qc["ERCC-00130",]))
# #mean(counts(sce4_qc["ERCC-00130",]))
# # about 30
# 
# SpikeInfo = data.frame(ERCCID=cms_095046$ERCC.ID, count=cms_095046$concentration.in.Mix.1..attomoles.ul.)
# SpikeInfo = SpikeInfo[SpikeInfo$ERCCID %in% rownames(sce4_qc_B)[isSpike(sce4_qc_B)],]
# rownames(SpikeInfo) = SpikeInfo$ERCCID
# SpikeInfo[,2] = SpikeInfo[,2]/1000
# metadata(sce4_qc_B) <- list(SpikeInput = SpikeInfo[rownames(sce4_qc_B)[isSpike(sce4_qc_B)],2],BatchInfo = colData(sce4_qc_B)$cell_line)
# 
# chain <- BASiCS_MCMC(sce4_qc_B, N = 10000, Thin = 10, Burn = 500, PrintProgress = TRUE, StoreChains = TRUE, StoreDir = "/wehisan/home/allstaff/d/dong.x/mixture", RunName = "NN84_RPI4")
# # time2 <- Sys.time()
# # chain <- readRDS("chain_NN84_RPI4.Rds")
# 
# DenoisedCounts <- BASiCS_DenoisedCounts(Data = sce4_qc_B, Chain = chain)
# DenoisedCounts = DenoisedCounts[rownames(sce4_qc_B), colnames(sce4_qc_B)]
# assay(sce4_qc_B, "log2_BASiCS") = log2(DenoisedCounts + 1)
# # time3 <- Sys.time()
# # cor_df_BASiCS <- cor_sc_within(sce4_qc, "log2_BASiCS")
# # ggplot(data = cor_df_BASiCS, aes(x = factor(cell_line), y = cor_val, fill = factor(cell_line))) + geom_violin()
# })
# 
# # DenoisedCounts <- BASiCS_DenoisedCounts(Data = sce4_qc, Chain = chain)
# # DenoisedCounts = DenoisedCounts[rownames(sce4_qc_B), colnames(sce4_qc)]
# # assay(sce4_qc, "log2_BASiCS") = log2(DenoisedCounts + 1)
# detach("package:BASiCS", unload=TRUE) 

```

```{r}
load("benchmark_BASiCS.RData")
assay(sce4_qc, "log2_BASiCS") = log2(DenoisedCounts[match(rownames(sce4_qc), rownames(sce4_qc_B)),] + 1)
rm(sce4_qc_B)
```


## `scone` normalization

```{r}
library(scone)

expr <- counts(sce4_qc)
bio <- factor(sce4_qc$cell_line)


#Read in housekeeping gene list and convert gene symbol to ensembl gene ID using biomaRt.


hkgene <- read.csv("h-scHKgenes.csv", stringsAsFactors = FALSE, col.names = 1)
library(biomaRt)
ensembl = useMart("ensembl")
ensembl = useDataset("hsapiens_gene_ensembl", mart = ensembl)
hk <- getBM(attributes = c("ensembl_gene_id", "hgnc_symbol"), filters = "hgnc_symbol", mart = ensembl, values = hkgene$X1)


#Use housekeeping genes as negetive control
#time1 <- Sys.time()
time_scone <- system.time({
  negcon <- intersect(rownames(expr), hk$ensembl_gene_id)
  # creating a SconeExperiment Object
  my_scone <- SconeExperiment(expr, bio = bio, negcon_ruv = rownames(expr) %in% negcon)
  
  scaling=list(none=identity, # Identity - do nothing
               
               # eff = EFF_FN, # User-defined function
               
               sum = SUM_FN, # SCONE library wrappers...
               tmm = TMM_FN, 
               uq = UQ_FN,
               fq = FQT_FN,
               deseq = DESEQ_FN)
  
  BiocParallel::register(
    BiocParallel::SerialParam()
  ) # Register BiocParallel Serial Execution
  
  my_scone <- scone(my_scone,
                    #imputation = imputation, impute_args = impute_args,
                    scaling=scaling,
                    run=TRUE,
                    eval_kclust = 2:6,stratified_pam = TRUE,
                    k_qc=0, k_ruv = 3,
                    adjust_bio="no",
                    return_norm = "in_memory",
                    zero = "postadjust")
  # NO RUV
  
  
  # load("my_scone.RData")
  # library(scone)
  
  scores <- get_scores(my_scone)
  score_ranks <- get_score_ranks(my_scone)
  out_norm = get_normalized(my_scone,method = rownames(get_params(my_scone))[1])
  
  assay(sce4_qc, "scone") = log2(out_norm + 1)
})
# time2 <- Sys.time()
# time_scone <- c("scone", time2 - time1)
# cor_df_scone <- cor_sc_within(sce4_qc, "scone")
# ggplot(data = cor_df_scone, aes(x = factor(cell_line), y = cor_val, fill = factor(cell_line))) + geom_violin()
detach("package:scone", unload=TRUE) 
detach("package:biomaRt", unload=TRUE) 
```

## DrImpute

```{r}
library(DrImpute)
# time1 <- Sys.time()
time_DrImpute_scran <-system.time({
imp <- DrImpute(assay(sce4_qc, "scran"))
assay(sce4_qc, "scran_DrImpute") <- imp
})
time_DrImpute_scran <- time_DrImpute_scran + time_scran
# time2 <- Sys.time()
# time_DrImpute_scran <- c("DrImpute+scran", time2 - time1)
# NOTE: this is just the time of running DrImpute.
# cor_df_DrImpute = cor_sc_within(sce4_qc, "scran_DrImpute")
# ggplot(data = cor_df_DrImpute, aes(x = factor(cell_line), y = cor_val, fill = factor(cell_line))) + geom_violin()
```

```{r}
library(DrImpute)
#time1 <- Sys.time()
time_DrImpute <- system.time({
sf <- apply(counts(sce4_qc), 2, mean)
tcount <- t(t(counts(sce4_qc)) / sf)
tcount <- log(tcount + 1)
impcount <- DrImpute(tcount)
assay(sce4_qc, "totalcount") <- tcount
assay(sce4_qc, "totalcount_DrImpute") <- impcount
})
# time2 <- Sys.time()
# time_DrImpute <- c("DrImpute", time2 - time1)
# cor_df_totalcount = cor_sc_within(sce4_qc, "totalcount")
# cor_df_DrImputeTotalcount = cor_sc_within(sce4_qc, "totalcount_DrImpute")
# ggplot(data = cor_df_totalcount, aes(x = factor(cell_line), y = cor_val, fill = factor(cell_line))) + geom_violin()+ ggtitle("total count")
# ggplot(data = cor_df_DrImputeTotalcount, aes(x = factor(cell_line), y = cor_val, fill = factor(cell_line))) + geom_violin()+ ggtitle("total count+DrImpute")
testp1 <- plotPCASCE(sce4_qc, exprs_values = "totalcount_DrImpute", colour_by = "cell_line") + ggtitle("total count+DrImpute")
testp2 <-plotPCASCE(sce4_qc, exprs_values = "totalcount", colour_by = "cell_line") + ggtitle("total count")
multiplot(testp2 ,testp1)
detach("package:DrImpute", unload=TRUE) 

```
<!--
## scImpute + scran

This package is designed to be applied before all kinds of data analysis, even QC. We may try this later.

```{r}
library(scImpute)
assay(sce4_qc, "raw") = counts(sce4_qc)


```
-->

## SAVER + scran

```{r}
library(SAVER)

library(doParallel)
time_SAVER <- system.time({
registerDoParallel(cores = 64)
sce4_qc <- computeSumFactors(sce4_qc)
saver_out <- saver(counts(sce4_qc), size.factor = sizeFactors(sce4_qc))
#load("saver_out.RData")
assay(sce4_qc, "SAVER_scran") <- log2(saver_out$estimate + 1)
})
# cor_df_SAVER = cor_sc_within(sce4_qc, "SAVER_scran")
# ggplot(data = cor_df_SAVER, aes(x = factor(cell_line), y = cor_val, fill = factor(cell_line))) + geom_violin()
```

## Linnorm

```{r}
library(Linnorm)
time_Linnorm <- system.time({
# time1 <- Sys.time()
linnorm_normalized <- Linnorm(counts(sce4_qc))
assay(sce4_qc, "linnorm") <- linnorm_normalized
})

# time2 <- Sys.time()
# time_Linnorm <- c("linnorm", time2 - time1)
# cor_df_linnorm = cor_sc_within(sce4_qc, "linnorm")
# ggplot(data = cor_df_linnorm, aes(x = factor(cell_line), y = cor_val, fill = factor(cell_line))) + geom_violin()
```

<!--
Imputation will reduce the number of gene.

```{r}
linnorm_imp <- Linnorm(counts(sce4_qc), DataImputation = TRUE)
dim(linnorm_imp)
# assay(sce4_qc, "linnormImp") <- linnorm_imp
# cor_df_linnormImp = cor_sc_within(sce4_qc, "linnormImp")
# ggplot(data = cor_df_linnormImp, aes(x = factor(cell_line), y = cor_val, fill = factor(cell_line))) + geom_violin()
# plotPCA(sce4_qc, exprs_value = "linnormImp", colour_by = "cell_line")
```
-->


## zinbwave

```{r}
load("zinbwave_sc.RData")
assay(sce4_qc, "zinbwave") <- assay(se_norm, "normalizedValues")

```

## Correlation

```{r}
# cor_all <- rbind(
#   cbind(cor_df_raw, method = rep("raw count", nrow(cor_df_raw))), 
#   cbind(cor_df_totalcount, method = rep("total read count", nrow(cor_df_totalcount))), 
#   cbind(cor_df_DrImputeTotalcount, method = rep("total read count+DrImpute", nrow(cor_df_DrImpute))),
#   cbind(cor_df_cpm, method = rep("cpm", nrow(cor_df_cpm))), 
#   cbind(cor_df_scran, method = rep("scran", nrow(cor_df_scran))),
#   cbind(cor_df_DrImpute, method = rep("scran+DrImpute", nrow(cor_df_DrImpute))),
#   cbind(cor_df_SAVER, method = rep("scran+SAVER", nrow(cor_df_SAVER))),
#   cbind(cor_df_SCnorm, method = rep("SCnorm", nrow(cor_df_SCnorm))),
#   cbind(cor_df_TMM, method = rep("TMM", nrow(cor_df_TMM))),
#   cbind(cor_df_DESeq, method = rep("DESeq", nrow(cor_df_DESeq))),
#   cbind(cor_df_knn, method = rep("kNN", nrow(cor_df_knn))),
#   cbind(cor_df_knn63, method = rep("kNN63", nrow(cor_df_knn63))),
#   cbind(cor_df_BASiCS, method = rep("BASiCS", nrow(cor_df_BASiCS))),
#   cbind(cor_df_scone, method = rep("scone", nrow(cor_df_scone))),
#   cbind(cor_df_linnorm, method = rep("Linnorm", nrow(cor_df_linnorm)))
#   )
# #pdf("benchmark/cor_CEL-seq2.pdf")
# ggplot(data = cor_all, aes(x = factor(method), y = cor_val, fill = factor(method))) + geom_boxplot() + theme_bw()+ theme(axis.text.x =element_blank(), axis.ticks.x = element_blank(), axis.title.x = element_blank())
# #dev.off()
```




## PCA plot visualization

```{r}
logcounts(sce4_qc) <- log2(counts(sce4_qc) + 1)

PCA1 <- runPCA(sce4_qc, exprs_values = "logcounts", ncomponents = 2)
PCA2 <- runPCA(sce4_qc, exprs_values = "norm_cpm", ncomponents = 2)
PCA3 <- runPCA(sce4_qc, exprs_values = "scran", ncomponents = 2) 
PCA4 <- runPCA(sce4_qc, exprs_values = "SCnorm", ncomponents = 2) 
PCA5 <- runPCA(sce4_qc, exprs_values = "TMM", ncomponents = 2) 
PCA6 <- runPCA(sce4_qc, exprs_values = "DESeq", ncomponents = 2)
# PCA7 <- runPCA(sce4_qc, exprs_values = "knn15", ncomponents = 2)
PCA8 <- runPCA(sce4_qc, exprs_values = "knn63", ncomponents = 2) 
PCA9 <- runPCA(sce4_qc, exprs_values = "log2_BASiCS", ncomponents = 2)
PCA10 <- runPCA(sce4_qc, exprs_values = "scone", ncomponents = 2)
PCA11 <- runPCA(sce4_qc, exprs_values = "scran_DrImpute", ncomponents = 2)
PCA12 <- runPCA(sce4_qc, exprs_values = "SAVER_scran", ncomponents = 2)
PCA13 <- runPCA(sce4_qc, exprs_values = "linnorm", ncomponents = 2)
PCA14 <- runPCA(sce4_qc, exprs_values = "zinbwave", ncomponents = 2)
# PCA14 <- runPCA(sce4_qc, exprs_values = "totalcount", ncomponents = 2)
# PCA15 <- runPCA(sce4_qc, exprs_values = "totalcount_DrImpute", ncomponents = 2)


p1 <- plotPCASCE(PCA1, colour_by = "cell_line", exprs_values = "logcounts", ncomponents = 2) + ggtitle("log raw counts")+ theme(legend.position="none")+ scale_fill_manual(values = c("#FF0000", "#00FF00", "#0000FF"), limits = c("H1975", "H2228", "HCC827"))
p2 <- plotPCASCE(PCA2, colour_by = "cell_line", exprs_values = "norm_cpm", ncomponents = 2) + ggtitle("CPM")+ theme(legend.position="none")+ scale_fill_manual(values = c("#FF0000", "#00FF00", "#0000FF"), limits = c("H1975", "H2228", "HCC827"))
p3 <- plotPCASCE(PCA3, colour_by = "cell_line", exprs_values = "scran", ncomponents = 2) + ggtitle("scran")+ theme(legend.position="none")+ scale_fill_manual(values = c("#FF0000", "#00FF00", "#0000FF"), limits = c("H1975", "H2228", "HCC827"))
p4 <- plotPCASCE(PCA4, colour_by = "cell_line", exprs_values = "SCnorm", ncomponents = 2) + ggtitle("SCnorm")+ theme(legend.position="none")+ scale_fill_manual(values = c("#FF0000", "#00FF00", "#0000FF"), limits = c("H1975", "H2228", "HCC827"))
p5 <- plotPCASCE(PCA5, colour_by = "cell_line", exprs_values = "TMM", ncomponents = 2) + ggtitle("TMM")+ theme(legend.position="none")+ scale_fill_manual(values = c("#FF0000", "#00FF00", "#0000FF"), limits = c("H1975", "H2228", "HCC827"))
p6 <- plotPCASCE(PCA6, colour_by = "cell_line", exprs_values = "DESeq", ncomponents = 2) + ggtitle("DESeq")+ theme(legend.position="none")+ scale_fill_manual(values = c("#FF0000", "#00FF00", "#0000FF"), limits = c("H1975", "H2228", "HCC827"))
# p7 <- plotPCASCE(PCA7, colour_by = "cell_line", exprs_values = "knn15", ncomponents = 2) + ggtitle("kNN (k=15)")+ theme(legend.position="none")+ scale_fill_manual(values = c("#FF0000", "#00FF00", "#0000FF"), limits = c("H1975", "H2228", "HCC827"))
p8 <- plotPCASCE(PCA8, colour_by = "cell_line", exprs_values = "knn63", ncomponents = 2) + ggtitle("kNN (k=63)")+ theme(legend.position="none")+ scale_fill_manual(values = c("#FF0000", "#00FF00", "#0000FF"), limits = c("H1975", "H2228", "HCC827"))
p9 <- plotPCASCE(PCA9, colour_by = "cell_line", exprs_values = "log2_BASiCS", ncomponents = 2) + ggtitle("BASiCS")+ theme(legend.position="none")+ scale_fill_manual(values = c("#FF0000", "#00FF00", "#0000FF"), limits = c("H1975", "H2228", "HCC827"))
p10 <- plotPCASCE(PCA10, colour_by = "cell_line", exprs_values = "scone", ncomponents = 2) + ggtitle("scone")+ theme(legend.position="none")+ scale_fill_manual(values = c("#FF0000", "#00FF00", "#0000FF"), limits = c("H1975", "H2228", "HCC827"))
p11 <- plotPCASCE(PCA11, colour_by = "cell_line", exprs_values = "scran_DrImpute", ncomponents = 2) + ggtitle("scran+DrImpute")+ theme(legend.position="none")+ scale_fill_manual(values = c("#FF0000", "#00FF00", "#0000FF"), limits = c("H1975", "H2228", "HCC827"))
p12 <- plotPCASCE(PCA12, colour_by = "cell_line", exprs_values = "SAVER_scran", ncomponents = 2) + ggtitle("scran+SAVER")+ theme(legend.position="none")+ scale_fill_manual(values = c("#FF0000", "#00FF00", "#0000FF"), limits = c("H1975", "H2228", "HCC827"))
p13 <- plotPCASCE(PCA13, colour_by = "cell_line", exprs_values = "linnorm", ncomponents = 2) + ggtitle("Linnorm")+ theme(legend.position="none")+ scale_fill_manual(values = c("#FF0000", "#00FF00", "#0000FF"), limits = c("H1975", "H2228", "HCC827"))
# p14 <- plotPCASCE(PCA14, colour_by = "cell_line", exprs_values = "totalcount", ncomponents = 2) + ggtitle("total count")+ theme(legend.position="none")
# p15 <- plotPCASCE(PCA15, colour_by = "cell_line", exprs_values = "totalcount_DrImpute", ncomponents = 2) + ggtitle("total count+DrImpute")+ theme(legend.position="none")
p14 <- plotPCASCE(PCA14, colour_by = "cell_line", exprs_values = "zinbwave", ncomponents = 2) + ggtitle("zinbwave")+ theme(legend.position="none")+ scale_fill_manual(values = c("#FF0000", "#00FF00", "#0000FF"), limits = c("H1975", "H2228", "HCC827"))

pdf("benchmark/thesis/PCA_sc_CEL-seq.pdf",height = 9)
# multiplot(p1, p14, p15, p2, p3, p11, p12, p4, p5, p6, p7, p8, p9, p10, p13, cols = 4)
# multiplot(p1, p2, p3, p11, p12, p4, p5, p6,  p8, p9, p10,p13, cols = 4)
multiplot( p1,p2, p3,  p4, p5, p6,  p8, p9, p10,p13,p14, cols = 3)
dev.off()

```

## silhouette width

```{r}
sil1 <- calcSilhouette(PCA1, "raw count")
sil2 <- calcSilhouette(PCA2, "CPM")
sil3 <- calcSilhouette(PCA3, "scran")
sil4 <- calcSilhouette(PCA4, "SCnorm")
sil5 <- calcSilhouette(PCA5, "TMM")
sil6 <- calcSilhouette(PCA6, "DESeq")
# sil7 <- calcSilhouette(PCA7, "kNN (k=15)")
sil8 <- calcSilhouette(PCA8, "kNN (k=63)")
sil9 <- calcSilhouette(PCA9, "BASiCS")
sil10 <- calcSilhouette(PCA10, "scone")
sil11 <- calcSilhouette(PCA11, "scran+DrImpute")
sil12 <- calcSilhouette(PCA12, "scran+SAVER")
sil13 <- calcSilhouette(PCA13, "Linnorm")
sil14 <- calcSilhouette(PCA14, "zinbwave")
sil15 <- calcSilhouette(se_norm, "zinbwave W")
# sil14 <- calcSilhouette(PCA14, "total count")
# sil15 <- calcSilhouette(PCA15, "total count+DrImpute")
#sil_all <- rbind(sil1,sil14,sil15,sil2,sil3,sil11,sil12,sil4,sil5,sil6,sil7,sil8,sil9, sil10, sil13)
#sil_all <- rbind(sil1, sil2, sil3, sil4, sil5, sil6, sil7, sil8, sil9, sil10, sil11, sil12, sil13, sil14, sil15)
sil_all <- rbind(sil1, sil2, sil3, sil4, sil5, sil6,  sil8, sil9, sil10, sil11, sil12, sil13, sil14, sil15)

# pdf("benchmark/silhouette_CEL-seq.pdf", height = 4)
ggplot(sil_all[sil_all$method != "scran+SAVER" & sil_all$method != "scran+DrImpute",], aes(x = reorder(method, sil_width), y=sil_width, fill=reorder(method, sil_width))) + geom_boxplot() + stat_summary(fun.y=mean, geom="point",size=2) + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + theme(legend.position = "none")+ labs(x="method", y="silhouette width")
# dev.off()

write.csv(sil_all, "benchmark/sc_sil_all.csv")
```

### timer

box plot coloured by time elapsed
```{r}
library(viridis)
time_all <- rbind(time_CPM, time_DESeq, time_DrImpute, time_DrImpute_scran, time_knn1, time_knn3, time_knn7, time_knn15, time_knn31, time_knn63, time_knn127, time_knn255, time_raw, time_SCnorm, time_scone, time_scran, time_TMM, time_BASiCS, time_Linnorm, time_SAVER, time_zinbwave)
time_all <- data.frame(time_all)
time_all$method <- c("CPM", "DESeq", "total count+DrImpute", "scran+DrImpute", "kNN (k=1)", "kNN (k=3)", "kNN (k=7)", "kNN (k=15)", "kNN (k=31)", "kNN (k=63)", "kNN (k=127)", "kNN (k=255)", "raw count", "SCnorm", "scone", "scran", "TMM", "BASiCS", "Linnorm", "scran+SAVER", "zinbwave")
time_all_sil <- merge(sil_all, time_all, by = "method")
# pdf("benchmark/silhouette_time_CEL-seq.pdf")
# ggplot(time_all_sil, aes(x = reorder(method, sil_width), y=sil_width, fill=log10(elapsed))) + geom_boxplot() + stat_summary(fun.y=mean, geom="point",size=2) + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_viridis()
# dev.off()
#dim(time_all_sil)
```



```{r}
meanSil <- sapply(unique(time_all_sil$method), function(x){
  mean(time_all_sil[time_all_sil$method == x, "sil_width"])
}, simplify = TRUE)
medSil <- sapply(unique(time_all_sil$method), function(x){
  median(time_all_sil[time_all_sil$method == x, "sil_width"])
}, simplify = TRUE)
meanSil <- data.frame(meanSil, medSil, method = unique(time_all_sil$method))
meanSil <- merge(meanSil, time_all, by = "method")

# head(meanSil)

## only plot normalization methods
## same color scheme as the box plot
# pdf("benchmark/medsiltime.pdf", height=4)
ggplot(meanSil, aes(log10(elapsed), medSil, colour= reorder(method, medSil)))  + geom_text(aes(label=method)) + labs(x="log10 running time lapse", y="median silhouette width") +theme_bw()+ theme(legend.position = "none")
# dev.off()

write.csv(meanSil, "benchmark/sc_meanSil.csv")
```

similar analysis for kNN



```{r}
meanknnSil <- sapply(unique(time_knn_sil$method), function(x){
  mean(time_knn_sil[time_knn_sil$method == x, "sil_width"])
}, simplify = TRUE)
medknnSil <- sapply(unique(time_knn_sil$method), function(x){
  median(time_knn_sil[time_knn_sil$method == x, "sil_width"])
}, simplify = TRUE)
meanknnSil <- data.frame(meanknnSil, medknnSil, method = unique(time_knn_sil$method))
meanknnSil <- merge(meanknnSil, time_all, by = "method")

names(meanknnSil)[c(2,3)] <- c("meanSil", "medSil")
ggplot(meanknnSil, aes(log10(elapsed), medSil, colour= method)) + geom_point() + labs(x="log 10 running time lapse", y="median silhouette width") +theme_bw()
```

```{r}
knn <- grepl("^kNN", meanSil$method)
meanSil_all <- rbind( meanknnSil,meanSil[!knn,])
# pdf("benchmark/medsiltime_all.pdf", height=4)
ggplot(meanSil_all, aes(log10(elapsed), medSil, colour= method)) + geom_text(aes(label=method)) + labs(x="log 10 running time lapse", y="median silhouette width") +theme_bw()+ theme(legend.position = "none")
# dev.off()
```


A plot separated for imputation and scran

```{r}
sil_scran_based <- grepl("^scran", meanSil$method)
# pdf("medsiltime_scran_CEL-seq2.pdf")
ggplot(meanSil[sil_scran_based, ], aes(log10(elapsed), medSil, colour= reorder(method, medSil)))  + geom_text(aes(label=method)) + labs(x="log10 running time lapse", y="median silhouette width") +theme_bw()+ theme(legend.position = "none")
# dev.off()
```



# tesh kNN-smooth

```{r}
sce4_50 <- subsample_cell(sce4_qc, "H1975", .5)
table(sce4_50$cell_line)
```

```{r}
sce4_smoothed = knn_smoother(counts(sce4_50), k = 1)
assay(sce4_50, "knn1") = log2(sce4_smoothed + 1)
sce4_smoothed = knn_smoother(counts(sce4_50), k = 3)
assay(sce4_50, "knn3") = log2(sce4_smoothed + 1)
sce4_smoothed = knn_smoother(counts(sce4_50), k = 7)
assay(sce4_50, "knn7") = log2(sce4_smoothed + 1)
sce4_smoothed = knn_smoother(counts(sce4_50), k = 15)
assay(sce4_50, "knn15") = log2(sce4_smoothed + 1)
sce4_smoothed = knn_smoother(counts(sce4_50), k = 31)
assay(sce4_50, "knn31") = log2(sce4_smoothed + 1)
sce4_smoothed = knn_smoother(counts(sce4_50), k = 63)
assay(sce4_50, "knn63") = log2(sce4_smoothed + 1)
sce4_smoothed = knn_smoother(counts(sce4_50), k = 127)
assay(sce4_50, "knn127") = log2(sce4_smoothed + 1)
```
```{r}
k1_50 <- runPCA(sce4_50, exprs_values = "knn1")
k3_50 <- runPCA(sce4_50, exprs_values = "knn3")
k7_50 <- runPCA(sce4_50, exprs_values = "knn7")
k15_50 <- runPCA(sce4_50, exprs_values = "knn15")
k31_50 <- runPCA(sce4_50, exprs_values = "knn31")
k63_50 <- runPCA(sce4_50, exprs_values = "knn63")
k127_50 <- runPCA(sce4_50, exprs_values = "knn127")

PCAk1_50 <- plotPCASCE(k1_50, colour_by = "cell_line", exprs_values = "knn1", ncomponents = 2) + ggtitle("k = 1")+ theme(legend.position="none")
PCAk3_50 <- plotPCASCE(k3_50, colour_by = "cell_line", exprs_values = "knn3", ncomponents = 2) + ggtitle("k = 3")+ theme(legend.position="none")
PCAk7_50 <- plotPCASCE(k7_50, colour_by = "cell_line", exprs_values = "knn7", ncomponents = 2) + ggtitle("k = 7")+ theme(legend.position="none")
PCAk15_50 <- plotPCASCE(k15_50, colour_by = "cell_line", exprs_values = "knn15", ncomponents = 2) + ggtitle("k = 15")+ theme(legend.position="none")
PCAk31_50 <- plotPCASCE(k31_50, colour_by = "cell_line", exprs_values = "knn31", ncomponents = 2) + ggtitle("k = 31")+ theme(legend.position="none")
PCAk63_50 <- plotPCASCE(k63_50, colour_by = "cell_line", exprs_values = "knn63", ncomponents = 2) + ggtitle("k = 63")+ theme(legend.position="none")
PCAk127_50 <- plotPCASCE(k127_50, colour_by = "cell_line", exprs_values = "knn127", ncomponents = 2) + ggtitle("k = 127")+ theme(legend.position="none")

multiplot(PCAk1_50, PCAk3_50, PCAk7_50, PCAk15_50, PCAk31_50, PCAk63_50, PCAk127_50, cols=3)
```

```{r}
sil_k1_50 <- calcSilhouette(k1_50, "kNN (k=1)")
sil_k3_50 <- calcSilhouette(k3_50, "kNN (k=3)")
sil_k7_50 <- calcSilhouette(k7_50, "kNN (k=7)")
sil_k15_50 <- calcSilhouette(k15_50, "kNN (k=15)")
sil_k31_50 <- calcSilhouette(k31_50, "kNN (k=31)")
sil_k63_50 <- calcSilhouette(k63_50, "kNN (k=63)")
sil_k127_50 <- calcSilhouette(k127_50, "kNN (k=127)")

sil_knn_50 <- rbind(sil_k1_50, sil_k3_50, sil_k7_50, sil_k15_50, sil_k31_50, sil_k63_50, sil_k127_50)
ggplot(sil_knn_50, aes(x = method, y = sil_width, fill = factor(cluster))) + geom_boxplot() + theme_bw()
ggplot(sil_knn_50, aes(x = method, y = sil_width, fill = method)) + geom_boxplot() + theme_bw()
```
```{r}
sce4_25 <- subsample_cell(sce4_qc, "H1975", .25)
table(sce4_25$cell_line)
```

```{r}
sce4_smoothed = knn_smoother(counts(sce4_25), k = 1)
assay(sce4_25, "knn1") = log2(sce4_smoothed + 1)
sce4_smoothed = knn_smoother(counts(sce4_25), k = 3)
assay(sce4_25, "knn3") = log2(sce4_smoothed + 1)
sce4_smoothed = knn_smoother(counts(sce4_25), k = 7)
assay(sce4_25, "knn7") = log2(sce4_smoothed + 1)
sce4_smoothed = knn_smoother(counts(sce4_25), k = 15)
assay(sce4_25, "knn15") = log2(sce4_smoothed + 1)
sce4_smoothed = knn_smoother(counts(sce4_25), k = 31)
assay(sce4_25, "knn31") = log2(sce4_smoothed + 1)
sce4_smoothed = knn_smoother(counts(sce4_25), k = 63)
assay(sce4_25, "knn63") = log2(sce4_smoothed + 1)
sce4_smoothed = knn_smoother(counts(sce4_25), k = 127)
assay(sce4_25, "knn127") = log2(sce4_smoothed + 1)
```
```{r}
k1_25 <- runPCA(sce4_25, exprs_values = "knn1")
k3_25 <- runPCA(sce4_25, exprs_values = "knn3")
k7_25 <- runPCA(sce4_25, exprs_values = "knn7")
k15_25 <- runPCA(sce4_25, exprs_values = "knn15")
k31_25 <- runPCA(sce4_25, exprs_values = "knn31")
k63_25 <- runPCA(sce4_25, exprs_values = "knn63")
k127_25 <- runPCA(sce4_25, exprs_values = "knn127")

PCAk1_25 <- plotPCASCE(k1_25, colour_by = "cell_line", exprs_values = "knn1", ncomponents = 2) + ggtitle("k = 1")+ theme(legend.position="none")
PCAk3_25 <- plotPCASCE(k3_25, colour_by = "cell_line", exprs_values = "knn3", ncomponents = 2) + ggtitle("k = 3")+ theme(legend.position="none")
PCAk7_25 <- plotPCASCE(k7_25, colour_by = "cell_line", exprs_values = "knn7", ncomponents = 2) + ggtitle("k = 7")+ theme(legend.position="none")
PCAk15_25 <- plotPCASCE(k15_25, colour_by = "cell_line", exprs_values = "knn15", ncomponents = 2) + ggtitle("k = 15")+ theme(legend.position="none")
PCAk31_25 <- plotPCASCE(k31_25, colour_by = "cell_line", exprs_values = "knn31", ncomponents = 2) + ggtitle("k = 31")+ theme(legend.position="none")
PCAk63_25 <- plotPCASCE(k63_25, colour_by = "cell_line", exprs_values = "knn63", ncomponents = 2) + ggtitle("k = 63")+ theme(legend.position="none")
PCAk127_25 <- plotPCASCE(k127_25, colour_by = "cell_line", exprs_values = "knn127", ncomponents = 2) + ggtitle("k = 127")+ theme(legend.position="none")

multiplot(PCAk1_25, PCAk3_25, PCAk7_25, PCAk15_25, PCAk31_25, PCAk63_25, PCAk127_25, cols=3)
```

```{r}
sil_k1_25 <- calcSilhouette(k1_25, "kNN (k=1)")
sil_k3_25 <- calcSilhouette(k3_25, "kNN (k=3)")
sil_k7_25 <- calcSilhouette(k7_25, "kNN (k=7)")
sil_k15_25 <- calcSilhouette(k15_25, "kNN (k=15)")
sil_k31_25 <- calcSilhouette(k31_25, "kNN (k=31)")
sil_k63_25 <- calcSilhouette(k63_25, "kNN (k=63)")
sil_k127_25 <- calcSilhouette(k127_25, "kNN (k=127)")

sil_knn_25 <- rbind(sil_k1_25, sil_k3_25, sil_k7_25, sil_k15_25, sil_k31_25, sil_k63_25, sil_k127_25)
ggplot(sil_knn_25, aes(x = method, y = sil_width, fill = factor(cluster))) + geom_boxplot() + theme_bw()
ggplot(sil_knn_25, aes(x = method, y = sil_width, fill = method)) + geom_boxplot() + theme_bw()
```

```{r}
sce4_12.5 <- subsample_cell(sce4_qc, "H1975", .125)
table(sce4_12.5$cell_line)
```

```{r}
sce4_smoothed = knn_smoother(counts(sce4_12.5), k = 1)
assay(sce4_12.5, "knn1") = log2(sce4_smoothed + 1)
sce4_smoothed = knn_smoother(counts(sce4_12.5), k = 3)
assay(sce4_12.5, "knn3") = log2(sce4_smoothed + 1)
sce4_smoothed = knn_smoother(counts(sce4_12.5), k = 7)
assay(sce4_12.5, "knn7") = log2(sce4_smoothed + 1)
sce4_smoothed = knn_smoother(counts(sce4_12.5), k = 15)
assay(sce4_12.5, "knn15") = log2(sce4_smoothed + 1)
sce4_smoothed = knn_smoother(counts(sce4_12.5), k = 31)
assay(sce4_12.5, "knn31") = log2(sce4_smoothed + 1)
sce4_smoothed = knn_smoother(counts(sce4_12.5), k = 63)
assay(sce4_12.5, "knn63") = log2(sce4_smoothed + 1)
sce4_smoothed = knn_smoother(counts(sce4_12.5), k = 127)
assay(sce4_12.5, "knn127") = log2(sce4_smoothed + 1)
```
```{r}
k1_12.5 <- runPCA(sce4_12.5, exprs_values = "knn1")
k3_12.5 <- runPCA(sce4_12.5, exprs_values = "knn3")
k7_12.5 <- runPCA(sce4_12.5, exprs_values = "knn7")
k15_12.5 <- runPCA(sce4_12.5, exprs_values = "knn15")
k31_12.5 <- runPCA(sce4_12.5, exprs_values = "knn31")
k63_12.5 <- runPCA(sce4_12.5, exprs_values = "knn63")
k127_12.5 <- runPCA(sce4_12.5, exprs_values = "knn127")

PCAk1_12.5 <- plotPCASCE(k1_12.5, colour_by = "cell_line", exprs_values = "knn1", ncomponents = 2) + ggtitle("k = 1")+ theme(legend.position="none")
PCAk3_12.5 <- plotPCASCE(k3_12.5, colour_by = "cell_line", exprs_values = "knn3", ncomponents = 2) + ggtitle("k = 3")+ theme(legend.position="none")
PCAk7_12.5 <- plotPCASCE(k7_12.5, colour_by = "cell_line", exprs_values = "knn7", ncomponents = 2) + ggtitle("k = 7")+ theme(legend.position="none")
PCAk15_12.5 <- plotPCASCE(k15_12.5, colour_by = "cell_line", exprs_values = "knn15", ncomponents = 2) + ggtitle("k = 15")+ theme(legend.position="none")
PCAk31_12.5 <- plotPCASCE(k31_12.5, colour_by = "cell_line", exprs_values = "knn31", ncomponents = 2) + ggtitle("k = 31")+ theme(legend.position="none")
PCAk63_12.5 <- plotPCASCE(k63_12.5, colour_by = "cell_line", exprs_values = "knn63", ncomponents = 2) + ggtitle("k = 63")+ theme(legend.position="none")
PCAk127_12.5 <- plotPCASCE(k127_12.5, colour_by = "cell_line", exprs_values = "knn127", ncomponents = 2) + ggtitle("k = 127")+ theme(legend.position="none")

multiplot(PCAk1_12.5, PCAk3_12.5, PCAk7_12.5, PCAk15_12.5, PCAk31_12.5, PCAk63_12.5, PCAk127_12.5, cols=3)
```

```{r}
sil_k1_12.5 <- calcSilhouette(k1_12.5, "kNN (k=1)")
sil_k3_12.5 <- calcSilhouette(k3_12.5, "kNN (k=3)")
sil_k7_12.5 <- calcSilhouette(k7_12.5, "kNN (k=7)")
sil_k15_12.5 <- calcSilhouette(k15_12.5, "kNN (k=15)")
sil_k31_12.5 <- calcSilhouette(k31_12.5, "kNN (k=31)")
sil_k63_12.5 <- calcSilhouette(k63_12.5, "kNN (k=63)")
sil_k127_12.5 <- calcSilhouette(k127_12.5, "kNN (k=127)")

sil_knn_12.5 <- rbind(sil_k1_12.5, sil_k3_12.5, sil_k7_12.5, sil_k15_12.5, sil_k31_12.5, sil_k63_12.5, sil_k127_12.5)
ggplot(sil_knn_12.5, aes(x = method, y = sil_width, fill = factor(cluster))) + geom_boxplot() + theme_bw()
ggplot(sil_knn_12.5, aes(x = method, y = sil_width, fill = method)) + geom_boxplot() + theme_bw()
```

```{r}
sce4_6.25 <- subsample_cell(sce4_qc, "H1975", .0625)
table(sce4_6.25$cell_line)
```

```{r}
sce4_smoothed = knn_smoother(counts(sce4_6.25), k = 1)
assay(sce4_6.25, "knn1") = log2(sce4_smoothed + 1)
sce4_smoothed = knn_smoother(counts(sce4_6.25), k = 3)
assay(sce4_6.25, "knn3") = log2(sce4_smoothed + 1)
sce4_smoothed = knn_smoother(counts(sce4_6.25), k = 7)
assay(sce4_6.25, "knn7") = log2(sce4_smoothed + 1)
sce4_smoothed = knn_smoother(counts(sce4_6.25), k = 15)
assay(sce4_6.25, "knn15") = log2(sce4_smoothed + 1)
sce4_smoothed = knn_smoother(counts(sce4_6.25), k = 31)
assay(sce4_6.25, "knn31") = log2(sce4_smoothed + 1)
sce4_smoothed = knn_smoother(counts(sce4_6.25), k = 63)
assay(sce4_6.25, "knn63") = log2(sce4_smoothed + 1)
sce4_smoothed = knn_smoother(counts(sce4_6.25), k = 127)
assay(sce4_6.25, "knn127") = log2(sce4_smoothed + 1)
```
```{r}
k1_6.25 <- runPCA(sce4_6.25, exprs_values = "knn1")
k3_6.25 <- runPCA(sce4_6.25, exprs_values = "knn3")
k7_6.25 <- runPCA(sce4_6.25, exprs_values = "knn7")
k15_6.25 <- runPCA(sce4_6.25, exprs_values = "knn15")
k31_6.25 <- runPCA(sce4_6.25, exprs_values = "knn31")
k63_6.25 <- runPCA(sce4_6.25, exprs_values = "knn63")
k127_6.25 <- runPCA(sce4_6.25, exprs_values = "knn127")

PCAk1_6.25 <- plotPCASCE(k1_6.25, colour_by = "cell_line", exprs_values = "knn1", ncomponents = 2) + ggtitle("k = 1")+ theme(legend.position="none")
PCAk3_6.25 <- plotPCASCE(k3_6.25, colour_by = "cell_line", exprs_values = "knn3", ncomponents = 2) + ggtitle("k = 3")+ theme(legend.position="none")
PCAk7_6.25 <- plotPCASCE(k7_6.25, colour_by = "cell_line", exprs_values = "knn7", ncomponents = 2) + ggtitle("k = 7")+ theme(legend.position="none")
PCAk15_6.25 <- plotPCASCE(k15_6.25, colour_by = "cell_line", exprs_values = "knn15", ncomponents = 2) + ggtitle("k = 15")+ theme(legend.position="none")
PCAk31_6.25 <- plotPCASCE(k31_6.25, colour_by = "cell_line", exprs_values = "knn31", ncomponents = 2) + ggtitle("k = 31")+ theme(legend.position="none")
PCAk63_6.25 <- plotPCASCE(k63_6.25, colour_by = "cell_line", exprs_values = "knn63", ncomponents = 2) + ggtitle("k = 63")+ theme(legend.position="none")
PCAk127_6.25 <- plotPCASCE(k127_6.25, colour_by = "cell_line", exprs_values = "knn127", ncomponents = 2) + ggtitle("k = 127")+ theme(legend.position="none")

multiplot(PCAk1_6.25, PCAk3_6.25, PCAk7_6.25, PCAk15_6.25, PCAk31_6.25, PCAk63_6.25, PCAk127_6.25, cols=3)
```
```{r}
plotPCASCE(sce4_6.25, exprs_values = "knn63", colour_by = "cell_line", ncomponents = 4)
plotPCASCE(sce4_6.25, exprs_values = "knn127", colour_by = "cell_line", ncomponents = 4)
```

```{r}
sil_k1_6.25 <- calcSilhouette(k1_6.25, "kNN (k=1)")
sil_k3_6.25 <- calcSilhouette(k3_6.25, "kNN (k=3)")
sil_k7_6.25 <- calcSilhouette(k7_6.25, "kNN (k=7)")
sil_k15_6.25 <- calcSilhouette(k15_6.25, "kNN (k=15)")
sil_k31_6.25 <- calcSilhouette(k31_6.25, "kNN (k=31)")
sil_k63_6.25 <- calcSilhouette(k63_6.25, "kNN (k=63)")
sil_k127_6.25 <- calcSilhouette(k127_6.25, "kNN (k=127)")

sil_knn_6.25 <- rbind(sil_k1_6.25, sil_k3_6.25, sil_k7_6.25, sil_k15_6.25, sil_k31_6.25, sil_k63_6.25, sil_k127_6.25)
ggplot(sil_knn_6.25, aes(x = method, y = sil_width, fill = factor(cluster))) + geom_boxplot() + theme_bw()
ggplot(sil_knn_6.25, aes(x = method, y = sil_width, fill = method)) + geom_boxplot() + theme_bw()
```
```{r}
sil_knn_sub <- rbind(cbind(sil_knn, H1975_prop = rep(100, nrow(sil_knn))),
                     cbind(sil_knn_50, H1975_prop = rep(50, nrow(sil_knn_50))),
                     cbind(sil_knn_25, H1975_prop = rep(25, nrow(sil_knn_25))),
                     cbind(sil_knn_12.5, H1975_prop = rep(12.5, nrow(sil_knn_12.5))),
                     cbind(sil_knn_6.25, H1975_prop = rep(6.25, nrow(sil_knn_6.25))))
sil_knn_sub <- sil_knn_sub[sil_knn_sub$method != "kNN (k=255)",]
  
ggplot(sil_knn_sub, aes(x = method, y = sil_width, fill = factor(H1975_prop))) + geom_boxplot() + theme_bw()
```

```{r}
#sil_knn_mid <- data.frame()
med <- c()
k_value <- c()
sub <- c()
ave <-c()
for(k in unique(sil_knn_sub$method)){
  for(p in unique(sil_knn_sub$H1975_prop)){
    mid <- median(sil_knn_sub[sil_knn_sub$method == k & sil_knn_sub$H1975_prop == p, "sil_width"])
    ave_sil <- mean(sil_knn_sub[sil_knn_sub$method == k & sil_knn_sub$H1975_prop == p, "sil_width"])
    med = c(med, mid)
    k_value = c(k_value, k)
    sub = c(sub, p)
    ave = c(ave, ave_sil)
  }
}
sil_knn_mid = data.frame(median_sil = med, k_value = k_value, H1975_prop = sub, mean_sil=ave)
library(stringr)
sil_knn_mid$k_value <- c(str_extract_all(k_value, "\\d+", simplify = TRUE))
# sil_knn_mid$k_value <- as.numeric(sub("kNN", "", sil_knn_mid$k))
# sil_knn_mid$k_value <- as.numeric(sub(")", "", sil_knn_mid$k))
#qplot(x = log2(as.numeric(sil_knn_mid$k) + 1), y = log2(sil_knn_mid$sub), size = sil_knn_mid$med )
#qplot(x = log2(sil_knn_mid$k + 1), y = log2(sil_knn_mid$sub / 100), size = sil_knn_mid$med )
detach("package:stringr", unload=TRUE) 
sil_knn_mid$cell_number <- ceiling(sil_knn_mid$H1975_prop * 110 / 100)
library(viridis)
# pdf("benchmark/kNN.pdf", height = 4)
ggplot(sil_knn_mid, aes(factor(k_value, levels=unique(sil_knn_mid$k_value)), factor(cell_number)))+ geom_tile(aes(fill = mean_sil), colour = "white") + ggtitle("mean silhouette width")+scale_fill_viridis(direction = -1) + labs(x = "k value", y = "H1975 cell number") +geom_text(aes(label=round(mean_sil,3)), colour="white")
ggplot(sil_knn_mid, aes(factor(k_value, levels=unique(sil_knn_mid$k_value)), factor(cell_number)))+ geom_tile(aes(fill = median_sil), colour = "white") + ggtitle("median silhouette width")+scale_fill_viridis(direction = -1)+ labs(x = "k value", y = "H1975 cell number")+geom_text(aes(label=round(mean_sil,3)), colour="white")
# dev.off()
```



# Imputation
```{r}
library(DrImpute)
#Linnorm
imp <- DrImpute(assay(sce4_qc, "linnorm"))
assay(sce4_qc, "linnorm_DrImpute") <- imp
#scone
imp <- DrImpute(assay(sce4_qc, "scone"))
assay(sce4_qc, "scone_DrImpute") <- imp
#SCnorm
imp <- DrImpute(assay(sce4_qc, "SCnorm"))
assay(sce4_qc, "SCnorm_DrImpute") <- imp
#BASiCS
imp <- DrImpute(assay(sce4_qc, "log2_BASiCS"))
assay(sce4_qc, "BASiCS_DrImpute") <- imp
#DESeq
imp <- DrImpute(assay(sce4_qc, "DESeq"))
assay(sce4_qc, "DESeq_DrImpute") <- imp
#CPM
imp <- DrImpute(assay(sce4_qc, "norm_cpm"))
assay(sce4_qc, "CPM_DrImpute") <- imp
#TMM
imp <- DrImpute(assay(sce4_qc, "TMM"))
assay(sce4_qc, "TMM_DrImpute") <- imp
```

```{r}

PCA_imp1 <- runPCA(sce4_qc, exprs_values = "linnorm_DrImpute")
PCA_imp2 <- runPCA(sce4_qc, exprs_values = "scone_DrImpute")
PCA_imp3 <- runPCA(sce4_qc, exprs_values = "SCnorm_DrImpute")
PCA_imp4 <- runPCA(sce4_qc, exprs_values = "BASiCS_DrImpute")
PCA_imp5 <- runPCA(sce4_qc, exprs_values = "DESeq_DrImpute")
PCA_imp6 <- runPCA(sce4_qc, exprs_values = "CPM_DrImpute")
PCA_imp7 <- runPCA(sce4_qc, exprs_values = "TMM_DrImpute")

p_imp1 <- plotPCASCE(PCA_imp1, colour_by = "cell_line", exprs_values = "linnorm_DrImpute", ncomponents = 2) + ggtitle("linnorm_DrImpute")+ theme(legend.position="none")
p_imp2 <- plotPCASCE(PCA_imp2, colour_by = "cell_line", exprs_values = "scone_DrImpute", ncomponents = 2) + ggtitle("scone_DrImpute")+ theme(legend.position="none")
p_imp3 <- plotPCASCE(PCA_imp3, colour_by = "cell_line", exprs_values = "SCnorm_DrImpute", ncomponents = 2) + ggtitle("SCnorm_DrImpute")+ theme(legend.position="none")
p_imp4 <- plotPCASCE(PCA_imp4, colour_by = "cell_line", exprs_values = "BASiCS_DrImpute", ncomponents = 2) + ggtitle("BASiCS_DrImpute")+ theme(legend.position="none")
p_imp5 <- plotPCASCE(PCA_imp5, colour_by = "cell_line", exprs_values = "DESeq_DrImpute", ncomponents = 2) + ggtitle("DESeq_DrImpute")+ theme(legend.position="none")
p_imp6 <- plotPCASCE(PCA_imp6, colour_by = "cell_line", exprs_values = "CPM_DrImpute", ncomponents = 2) + ggtitle("CPM_DrImpute")+ theme(legend.position="none")
p_imp7 <- plotPCASCE(PCA_imp7, colour_by = "cell_line", exprs_values = "TMM_DrImpute", ncomponents = 2) + ggtitle("TMM_DrImpute")+ theme(legend.position="none")
pdf("benchmark/sc_impu.pdf", width = 9)
multiplot(p11, p_imp1, p_imp2, p_imp3, p_imp4, p_imp5, p_imp6, p_imp7, cols=3)
dev.off()
```

```{r}
sil_imp_1 <- calcSilhouette(PCA_imp1, "linnorm+DrImpute")
sil_imp_2 <- calcSilhouette(PCA_imp2, "scone+DrImpute")
sil_imp_3 <- calcSilhouette(PCA_imp3, "SCnorm+DrImpute")
sil_imp_4 <- calcSilhouette(PCA_imp4, "BASiCS+DrImpute")
sil_imp_5 <- calcSilhouette(PCA_imp5, "DESeq+DrImpute")
sil_imp_6 <- calcSilhouette(PCA_imp6, "CPM+DrImpute")
sil_imp_7 <- calcSilhouette(PCA_imp7, "TMM+DrImpute")

sil_imp <- rbind(sil_imp_1, sil_imp_2, sil_imp_3, sil_imp_4, sil_imp_5, sil_imp_6, sil_imp_7)
sil_all_imp <-rbind(sil_all, sil_imp)
```

```{r}
# pdf("benchmark/silhouette_CEL-seq_impu.pdf")
ggplot(sil_imp, aes(x = reorder(method, sil_width), y=sil_width, fill=reorder(method, sil_width))) + geom_boxplot() + stat_summary(fun.y=mean, geom="point",size=2) + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + theme(legend.position = "none")+ labs(x="method", y="silhouette width")
ggplot(sil_all_imp, aes(x = reorder(method, sil_width), y=sil_width, fill=reorder(method, sil_width))) + geom_boxplot() + stat_summary(fun.y=mean, geom="point",size=2) + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + theme(legend.position = "none")+ labs(x="method", y="silhouette width")
# dev.off()
```

combining DrImpute and CPM is VERY GOOD! why???

# Downsampling of H1975

## subsample test for scran

```{r}
sce4_50 <- computeSumFactors(sce4_50)
sce4_50 <- normalize(sce4_50)
assay(sce4_50, "scran") <- logcounts(sce4_50)
sce4_25 <- computeSumFactors(sce4_25)
sce4_25 <- normalize(sce4_25)
assay(sce4_25, "scran") <- logcounts(sce4_25)
sce4_12.5 <- computeSumFactors(sce4_12.5)
sce4_12.5 <- normalize(sce4_12.5)
assay(sce4_12.5, "scran") <- logcounts(sce4_12.5)
sce4_6.25 <- computeSumFactors(sce4_6.25)
sce4_6.25 <- normalize(sce4_6.25)
assay(sce4_6.25, "scran") <- logcounts(sce4_6.25)
```

```{r}
scran_100 <- runPCA(sce4_qc, exprs_values = "scran", ncomponents = 2)
scran_50 <- runPCA(sce4_50 ,exprs_values = "scran", ncomponents = 2)
scran_25 <- runPCA(sce4_25, exprs_values = "scran", ncomponents = 2)
scran_12.5 <- runPCA(sce4_12.5, exprs_values = "scran", ncomponents = 2)
scran_6.25 <- runPCA(sce4_6.25, exprs_values = "scran", ncomponents = 2)

PCAscran_100 <- plotPCASCE(scran_100, colour_by = "cell_line", exprs_values = "scran", ncomponents = 2) + ggtitle("1")+ theme(legend.position="none")
PCAscran_50 <- plotPCASCE(scran_50, colour_by = "cell_line",  exprs_values = "scran", ncomponents = 2) + ggtitle("0.5")+ theme(legend.position="none")
PCAscran_25 <- plotPCASCE(scran_25, colour_by = "cell_line", exprs_values = "scran", ncomponents = 2) + ggtitle("0.25")+ theme(legend.position="none")
PCAscran_12.5 <- plotPCASCE(scran_12.5, colour_by = "cell_line",  exprs_values = "scran",ncomponents = 2) + ggtitle("0.125")+ theme(legend.position="none")
PCAscran_6.25 <- plotPCASCE(scran_6.25, colour_by = "cell_line",  exprs_values = "scran",ncomponents = 2) + ggtitle("0.0625")+ theme(legend.position="none")

pdf("benchmark/downsample_scran.pdf", height = 4)
multiplot(PCAscran_100, PCAscran_50, PCAscran_25, PCAscran_12.5, PCAscran_6.25, cols = 3)
dev.off()
```

```{r}
plotPCASCE(sce4_25, ncomponents = 4, colour_by = "cell_line")
plotPCASCE(sce4_12.5, ncomponents = 4, colour_by = "cell_line")
plotPCASCE(sce4_6.25, ncomponents = 4, colour_by = "cell_line")
```

```{r}
sil_scran100 <- calcSilhouette(scran_100, "scran_100")
sil_scran50 <- calcSilhouette(scran_50, "scran_50")
sil_scran25 <- calcSilhouette(scran_25, "scran_25")
sil_scran12.5 <- calcSilhouette(scran_12.5, "scran_12.5")
sil_scran6.25 <- calcSilhouette(scran_6.25, "scran_6.25")

sil_scran <- rbind(sil_scran100, sil_scran50, sil_scran25, sil_scran12.5, sil_scran6.25)
ggplot(sil_scran, aes(x = method, y = sil_width, fill = factor(cluster))) + geom_boxplot() + theme_bw()
ggplot(sil_scran, aes(x = method, y = sil_width, fill = method)) + geom_boxplot() + theme_bw()
```

## subsample test for linnorm

```{r}
library(Linnorm)

linnorm_normalized <- Linnorm(counts(sce4_50))
assay(sce4_50, "linnorm") <- linnorm_normalized
linnorm_normalized <- Linnorm(counts(sce4_25))
assay(sce4_25, "linnorm") <- linnorm_normalized
linnorm_normalized <- Linnorm(counts(sce4_12.5))
assay(sce4_12.5, "linnorm") <- linnorm_normalized
linnorm_normalized <- Linnorm(counts(sce4_6.25))
assay(sce4_6.25, "linnorm") <- linnorm_normalized
```

```{r}
linnorm_100 <- runPCA(sce4_qc, exprs_values = "linnorm", ncomponents = 2)
linnorm_50  <- runPCA(sce4_50 ,exprs_values = "linnorm", ncomponents = 2)
linnorm_25  <- runPCA(sce4_25, exprs_values = "linnorm", ncomponents = 2)
linnorm_12.5 <- runPCA(sce4_12.5, exprs_values = "linnorm", ncomponents = 2)
linnorm_6.25 <- runPCA(sce4_6.25, exprs_values = "linnorm", ncomponents = 2)

PCAlinnorm_100 <- plotPCASCE(linnorm_100, colour_by = "cell_line", exprs_values = "linnorm", ncomponents = 2) + ggtitle("1")+ theme(legend.position="none")
PCAlinnorm_50 <- plotPCASCE(linnorm_50, colour_by = "cell_line",  exprs_values = "linnorm", ncomponents = 2) + ggtitle("0.5")+ theme(legend.position="none")
PCAlinnorm_25 <- plotPCASCE(linnorm_25, colour_by = "cell_line", exprs_values = "linnorm", ncomponents = 2) + ggtitle("0.25")+ theme(legend.position="none")
PCAlinnorm_12.5 <- plotPCASCE(linnorm_12.5, colour_by = "cell_line",  exprs_values = "linnorm",ncomponents = 2) + ggtitle("0.125")+ theme(legend.position="none")
PCAlinnorm_6.25 <- plotPCASCE(linnorm_6.25, colour_by = "cell_line",  exprs_values = "linnorm",ncomponents = 2) + ggtitle("0.0625")+ theme(legend.position="none")

pdf("benchmark/downsample_linnorm.pdf", height = 4)
multiplot(PCAlinnorm_100, PCAlinnorm_50, PCAlinnorm_25, PCAlinnorm_12.5, PCAlinnorm_6.25, cols = 3)
dev.off()
```

```{r}
sil_linnorm100 <- calcSilhouette(linnorm_100, "linnorm_100")
sil_linnorm50 <- calcSilhouette(linnorm_50, "linnorm_50")
sil_linnorm25 <- calcSilhouette(linnorm_25, "linnorm_25")
sil_linnorm12.5 <- calcSilhouette(linnorm_12.5, "linnorm_12.5")
sil_linnorm6.25 <- calcSilhouette(linnorm_6.25, "linnorm_6.25")

sil_linnorm <- rbind(sil_linnorm100, sil_linnorm50, sil_linnorm25, sil_linnorm12.5, sil_linnorm6.25)
ggplot(sil_linnorm, aes(x = method, y = sil_width, fill = factor(cluster))) + geom_boxplot() + theme_bw()
ggplot(sil_linnorm, aes(x = method, y = sil_width, fill = method)) + geom_boxplot() + theme_bw()
```

## Imputation

### scran+DrImpute 
```{r}
library(DrImpute)
imp <- DrImpute(assay(sce4_50, "scran"))
assay(sce4_50, "scran_DrImpute") <- imp
imp <- DrImpute(assay(sce4_25, "scran"))
assay(sce4_25, "scran_DrImpute") <- imp
imp <- DrImpute(assay(sce4_12.5, "scran"))
assay(sce4_12.5, "scran_DrImpute") <- imp
imp <- DrImpute(assay(sce4_6.25, "scran"))
assay(sce4_6.25, "scran_DrI
      mpute") <- imp

```

```{r}
scran_DrImpute_100 <- runPCA(sce4_qc, exprs_values = "scran_DrImpute", ncomponents = 2)
scran_DrImpute_50 <- runPCA(sce4_50 ,exprs_values = "scran_DrImpute", ncomponents = 2)
scran_DrImpute_25 <- runPCA(sce4_25, exprs_values = "scran_DrImpute", ncomponents = 2)
scran_DrImpute_12.5 <- runPCA(sce4_12.5, exprs_values = "scran_DrImpute", ncomponents = 2)
scran_DrImpute_6.25 <- runPCA(sce4_6.25, exprs_values = "scran_DrImpute", ncomponents = 2)

PCAscran_DrImpute_100 <- plotPCASCE(scran_DrImpute_100, colour_by = "cell_line", exprs_values = "scran_DrImpute", ncomponents = 2) + ggtitle("1")+ theme(legend.position="none")
PCAscran_DrImpute_50 <- plotPCASCE(scran_DrImpute_50, colour_by = "cell_line",  exprs_values = "scran_DrImpute", ncomponents = 2) + ggtitle("0.5")+ theme(legend.position="none")
PCAscran_DrImpute_25 <- plotPCASCE(scran_DrImpute_25, colour_by = "cell_line", exprs_values = "scran_DrImpute", ncomponents = 2) + ggtitle("0.25")+ theme(legend.position="none")
PCAscran_DrImpute_12.5 <- plotPCASCE(scran_DrImpute_12.5, colour_by = "cell_line",  exprs_values = "scran_DrImpute",ncomponents = 2) + ggtitle("0.125")+ theme(legend.position="none")
PCAscran_DrImpute_6.25 <- plotPCASCE(scran_DrImpute_6.25, colour_by = "cell_line",  exprs_values = "scran_DrImpute",ncomponents = 2) + ggtitle("0.0625")+ theme(legend.position="none")
multiplot(PCAscran_DrImpute_100, PCAscran_DrImpute_50, PCAscran_DrImpute_25, PCAscran_DrImpute_12.5, PCAscran_DrImpute_6.25, cols = 3)
```

```{r}
sil_scran_DrImpute100 <- calcSilhouette(scran_DrImpute_100, "scran_DrImpute_100")
sil_scran_DrImpute50 <- calcSilhouette(scran_DrImpute_50, "scran_DrImpute_50")
sil_scran_DrImpute25 <- calcSilhouette(scran_DrImpute_25, "scran_DrImpute_25")
sil_scran_DrImpute12.5 <- calcSilhouette(scran_DrImpute_12.5, "scran_DrImpute_12.5")
sil_scran_DrImpute6.25 <- calcSilhouette(scran_DrImpute_6.25, "scran_DrImpute_6.25")

sil_scran_DrImpute <- rbind(sil_scran_DrImpute100, sil_scran_DrImpute50, sil_scran_DrImpute25, sil_scran_DrImpute12.5, sil_scran_DrImpute6.25)
ggplot(sil_scran_DrImpute, aes(x = method, y = sil_width, fill = factor(cluster))) + geom_boxplot() + theme_bw()
ggplot(sil_scran_DrImpute, aes(x = method, y = sil_width, fill = method)) + geom_boxplot() + theme_bw()
```

### scran+SAVER

```{r}

library(SAVER)
library(doParallel)
registerDoParallel(cores = 64)

sce4_50 <- computeSumFactors(sce4_50)
saver_out <- saver(counts(sce4_50), size.factor = sizeFactors(sce4_50))
assay(sce4_50, "SAVER_scran") <- log2(saver_out$estimate + 1)

sce4_25 <- computeSumFactors(sce4_25)
saver_out <- saver(counts(sce4_25), size.factor = sizeFactors(sce4_25))
assay(sce4_25, "SAVER_scran") <- log2(saver_out$estimate + 1)

sce4_12.5 <- computeSumFactors(sce4_12.5)
saver_out <- saver(counts(sce4_12.5), size.factor = sizeFactors(sce4_12.5))
assay(sce4_12.5, "SAVER_scran") <- log2(saver_out$estimate + 1)

sce4_6.25 <- computeSumFactors(sce4_6.25)
saver_out <- saver(counts(sce4_6.25), size.factor = sizeFactors(sce4_6.25))
assay(sce4_6.25, "SAVER_scran") <- log2(saver_out$estimate + 1)


```

```{r}
scran_SAVER_100 <- runPCA(sce4_qc, exprs_values =    "SAVER_scran", ncomponents = 2)
scran_SAVER_50 <- runPCA(sce4_50 ,exprs_values =     "SAVER_scran", ncomponents = 2)
scran_SAVER_25 <- runPCA(sce4_25, exprs_values =     "SAVER_scran", ncomponents = 2)
scran_SAVER_12.5 <- runPCA(sce4_12.5, exprs_values = "SAVER_scran", ncomponents = 2)
scran_SAVER_6.25 <- runPCA(sce4_6.25, exprs_values = "SAVER_scran", ncomponents = 2)

PCAscran_SAVER_100 <- plotPCASCE(scran_SAVER_100, colour_by = "cell_line", exprs_values = "SAVER_scran", ncomponents = 2) + ggtitle("1")+ theme(legend.position="none")
PCAscran_SAVER_50 <- plotPCASCE(scran_SAVER_50, colour_by = "cell_line",  exprs_values = "SAVER_scran", ncomponents = 2) + ggtitle("0.5")+ theme(legend.position="none")
PCAscran_SAVER_25 <- plotPCASCE(scran_SAVER_25, colour_by = "cell_line", exprs_values = "SAVER_scran", ncomponents = 2) + ggtitle("0.25")+ theme(legend.position="none")
PCAscran_SAVER_12.5 <- plotPCASCE(scran_SAVER_12.5, colour_by = "cell_line",  exprs_values = "SAVER_scran",ncomponents = 2) + ggtitle("0.125")+ theme(legend.position="none")
PCAscran_SAVER_6.25 <- plotPCASCE(scran_SAVER_6.25, colour_by = "cell_line",  exprs_values = "SAVER_scran",ncomponents = 2) + ggtitle("0.0625")+ theme(legend.position="none")
multiplot(PCAscran_SAVER_100, PCAscran_SAVER_50, PCAscran_SAVER_25, PCAscran_SAVER_12.5, PCAscran_SAVER_6.25, cols = 3)
```

```{r}
sil_scran_SAVER100 <- calcSilhouette(scran_SAVER_100, "scran_SAVER_100")
sil_scran_SAVER50 <- calcSilhouette(scran_SAVER_50, "scran_SAVER_50")
sil_scran_SAVER25 <- calcSilhouette(scran_SAVER_25, "scran_SAVER_25")
sil_scran_SAVER12.5 <- calcSilhouette(scran_SAVER_12.5, "scran_SAVER_12.5")
sil_scran_SAVER6.25 <- calcSilhouette(scran_SAVER_6.25, "scran_SAVER_6.25")

sil_scran_SAVER <- rbind(sil_scran_SAVER100, sil_scran_SAVER50, sil_scran_SAVER25, sil_scran_SAVER12.5, sil_scran_SAVER6.25)
ggplot(sil_scran_SAVER, aes(x = method, y = sil_width, fill = factor(cluster))) + geom_boxplot() + theme_bw()
ggplot(sil_scran_SAVER, aes(x = method, y = sil_width, fill = method)) + geom_boxplot() + theme_bw()
```

### linnorm + DrImpute

```{r}
library(DrImpute)
imp <- DrImpute(assay(sce4_50, "linnorm"))
assay(sce4_50, "linnorm_DrImpute") <- imp
imp <- DrImpute(assay(sce4_25, "linnorm"))
assay(sce4_25, "linnorm_DrImpute") <- imp
imp <- DrImpute(assay(sce4_12.5, "linnorm"))
assay(sce4_12.5, "linnorm_DrImpute") <- imp
imp <- DrImpute(assay(sce4_6.25, "linnorm"))
assay(sce4_6.25, "linnorm_DrImpute") <- imp

```

```{r}
linnorm_DrImpute_100 <- runPCA(sce4_qc, exprs_values = "linnorm_DrImpute", ncomponents = 2)
linnorm_DrImpute_50 <- runPCA(sce4_50 ,exprs_values = "linnorm_DrImpute", ncomponents = 2)
linnorm_DrImpute_25 <- runPCA(sce4_25, exprs_values = "linnorm_DrImpute", ncomponents = 2)
linnorm_DrImpute_12.5 <- runPCA(sce4_12.5, exprs_values = "linnorm_DrImpute", ncomponents = 2)
linnorm_DrImpute_6.25 <- runPCA(sce4_6.25, exprs_values = "linnorm_DrImpute", ncomponents = 2)

PCAlinnorm_DrImpute_100 <- plotPCASCE(linnorm_DrImpute_100, colour_by = "cell_line", exprs_values = "linnorm_DrImpute", ncomponents = 2) + ggtitle("1")+ theme(legend.position="none")
PCAlinnorm_DrImpute_50 <- plotPCASCE(linnorm_DrImpute_50, colour_by = "cell_line",  exprs_values = "linnorm_DrImpute", ncomponents = 2) + ggtitle("0.5")+ theme(legend.position="none")
PCAlinnorm_DrImpute_25 <- plotPCASCE(linnorm_DrImpute_25, colour_by = "cell_line", exprs_values = "linnorm_DrImpute", ncomponents = 2) + ggtitle("0.25")+ theme(legend.position="none")
PCAlinnorm_DrImpute_12.5 <- plotPCASCE(linnorm_DrImpute_12.5, colour_by = "cell_line",  exprs_values = "linnorm_DrImpute",ncomponents = 2) + ggtitle("0.125")+ theme(legend.position="none")
PCAlinnorm_DrImpute_6.25 <- plotPCASCE(linnorm_DrImpute_6.25, colour_by = "cell_line",  exprs_values = "linnorm_DrImpute",ncomponents = 2) + ggtitle("0.0625")+ theme(legend.position="none")
multiplot(PCAlinnorm_DrImpute_100, PCAlinnorm_DrImpute_50, PCAlinnorm_DrImpute_25, PCAlinnorm_DrImpute_12.5, PCAlinnorm_DrImpute_6.25, cols = 3)
```

```{r}
sil_linnorm_DrImpute100 <- calcSilhouette(linnorm_DrImpute_100, "linnorm_DrImpute_100")
sil_linnorm_DrImpute50 <- calcSilhouette(linnorm_DrImpute_50, "linnorm_DrImpute_50")
sil_linnorm_DrImpute25 <- calcSilhouette(linnorm_DrImpute_25, "linnorm_DrImpute_25")
sil_linnorm_DrImpute12.5 <- calcSilhouette(linnorm_DrImpute_12.5, "linnorm_DrImpute_12.5")
sil_linnorm_DrImpute6.25 <- calcSilhouette(linnorm_DrImpute_6.25, "linnorm_DrImpute_6.25")

sil_linnorm_DrImpute <- rbind(sil_linnorm_DrImpute100, sil_linnorm_DrImpute50, sil_linnorm_DrImpute25, sil_linnorm_DrImpute12.5, sil_linnorm_DrImpute6.25)
ggplot(sil_linnorm_DrImpute, aes(x = method, y = sil_width, fill = factor(cluster))) + geom_boxplot() + theme_bw()
ggplot(sil_linnorm_DrImpute, aes(x = method, y = sil_width, fill = method)) + geom_boxplot() + theme_bw()
```

### CPM + DrImpute

```{r}
library(DrImpute)
# library(limma)
assay(sce4_50, "CPM") <- log2(edgeR::cpm(counts(sce4_50)) + 1)
imp <- DrImpute(assay(sce4_50, "CPM"))
assay(sce4_50, "CPM_DrImpute") <- imp
assay(sce4_25, "CPM") <- log2(edgeR::cpm(counts(sce4_25)) + 1)
imp <- DrImpute(assay(sce4_25, "CPM"))
assay(sce4_25, "CPM_DrImpute") <- imp
assay(sce4_12.5, "CPM") <- log2(edgeR::cpm(counts(sce4_12.5)) + 1)
imp <- DrImpute(assay(sce4_12.5, "CPM"))
assay(sce4_12.5, "CPM_DrImpute") <- imp
assay(sce4_6.25, "CPM") <- log2(edgeR::cpm(counts(sce4_6.25)) + 1)
imp <- DrImpute(assay(sce4_6.25, "CPM"))
assay(sce4_6.25, "CPM_DrImpute") <- imp
```

```{r}
CPM_100 <- runPCA(sce4_qc, exprs_values = "norm_cpm", ncomponents = 2)
CPM_50 <- runPCA(sce4_50 ,exprs_values = "CPM", ncomponents = 2)
CPM_25 <- runPCA(sce4_25, exprs_values = "CPM", ncomponents = 2)
CPM_12.5 <- runPCA(sce4_12.5, exprs_values = "CPM", ncomponents = 2)
CPM_6.25 <- runPCA(sce4_6.25, exprs_values = "CPM", ncomponents = 2)

CPM_DrImpute_100 <- runPCA(sce4_qc, exprs_values = "CPM_DrImpute", ncomponents = 2)
CPM_DrImpute_50 <- runPCA(sce4_50 ,exprs_values = "CPM_DrImpute", ncomponents = 2)
CPM_DrImpute_25 <- runPCA(sce4_25, exprs_values = "CPM_DrImpute", ncomponents = 2)
CPM_DrImpute_12.5 <- runPCA(sce4_12.5, exprs_values = "CPM_DrImpute", ncomponents = 2)
CPM_DrImpute_6.25 <- runPCA(sce4_6.25, exprs_values = "CPM_DrImpute", ncomponents = 2)

PCACPM_DrImpute_100 <- plotPCASCE(CPM_DrImpute_100, colour_by = "cell_line", exprs_values = "CPM_DrImpute", ncomponents = 2) + ggtitle("1")+ theme(legend.position="none")
PCACPM_DrImpute_50 <- plotPCASCE(CPM_DrImpute_50, colour_by = "cell_line",  exprs_values = "CPM_DrImpute", ncomponents = 2) + ggtitle("0.5")+ theme(legend.position="none")
PCACPM_DrImpute_25 <- plotPCASCE(CPM_DrImpute_25, colour_by = "cell_line", exprs_values = "CPM_DrImpute", ncomponents = 2) + ggtitle("0.25")+ theme(legend.position="none")
PCACPM_DrImpute_12.5 <- plotPCASCE(CPM_DrImpute_12.5, colour_by = "cell_line",  exprs_values = "CPM_DrImpute",ncomponents = 2) + ggtitle("0.125")+ theme(legend.position="none")
PCACPM_DrImpute_6.25 <- plotPCASCE(CPM_DrImpute_6.25, colour_by = "cell_line",  exprs_values = "CPM_DrImpute",ncomponents = 2) + ggtitle("0.0625")+ theme(legend.position="none")
multiplot(PCACPM_DrImpute_100, PCACPM_DrImpute_50, PCACPM_DrImpute_25, PCACPM_DrImpute_12.5, PCACPM_DrImpute_6.25, cols = 3)
```

```{r}
sil_CPM100 <- calcSilhouette(CPM_100, "CPM_100")
sil_CPM50 <- calcSilhouette(CPM_50, "CPM_50")
sil_CPM25 <- calcSilhouette(CPM_25, "CPM_25")
sil_CPM12.5 <- calcSilhouette(CPM_12.5, "CPM_12.5")
sil_CPM6.25 <- calcSilhouette(CPM_6.25, "CPM_6.25")

sil_CPM_DrImpute100 <- calcSilhouette(CPM_DrImpute_100, "CPM_DrImpute_100")
sil_CPM_DrImpute50 <- calcSilhouette(CPM_DrImpute_50, "CPM_DrImpute_50")
sil_CPM_DrImpute25 <- calcSilhouette(CPM_DrImpute_25, "CPM_DrImpute_25")
sil_CPM_DrImpute12.5 <- calcSilhouette(CPM_DrImpute_12.5, "CPM_DrImpute_12.5")
sil_CPM_DrImpute6.25 <- calcSilhouette(CPM_DrImpute_6.25, "CPM_DrImpute_6.25")

sil_CPM_DrImpute <- rbind(sil_CPM_DrImpute100, sil_CPM_DrImpute50, sil_CPM_DrImpute25, sil_CPM_DrImpute12.5, sil_CPM_DrImpute6.25)
sil_CPM <- rbind(sil_CPM100, sil_CPM50, sil_CPM25, sil_CPM12.5, sil_CPM6.25)
ggplot(sil_CPM, aes(x = method, y = sil_width, fill = factor(cluster))) + geom_boxplot() + theme_bw()+ggtitle("cpm")
ggplot(sil_CPM, aes(x = method, y = sil_width, fill = method)) + geom_boxplot() + theme_bw()+ggtitle("cpm")
ggplot(sil_CPM_DrImpute, aes(x = method, y = sil_width, fill = factor(cluster))) + geom_boxplot() + theme_bw()
ggplot(sil_CPM_DrImpute, aes(x = method, y = sil_width, fill = method)) + geom_boxplot() + theme_bw()
```

### CPM+SAVER
```{r}

library(SAVER)
library(doParallel)
registerDoParallel(cores = 64)

saver_out <- saver(edgeR::cpm(counts(sce4_qc)), size.factor = 1)
assay(sce4_qc, "SAVER_CPM") <- log2(saver_out$estimate + 1)

saver_out <- saver(edgeR::cpm(counts(sce4_50)), size.factor = 1)
assay(sce4_50, "SAVER_CPM") <- log2(saver_out$estimate + 1)


saver_out <- saver(edgeR::cpm(counts(sce4_25)), size.factor = 1)
assay(sce4_25, "SAVER_CPM") <- log2(saver_out$estimate + 1)


saver_out <- saver(edgeR::cpm(counts(sce4_12.5)), size.factor = 1)
assay(sce4_12.5, "SAVER_CPM") <- log2(saver_out$estimate + 1)

saver_out <- saver(edgeR::cpm(counts(sce4_6.25)), size.factor = 1)
assay(sce4_6.25, "SAVER_CPM") <- log2(saver_out$estimate + 1)


```
<!--
Error in est[ind4, ] <- out$est : 
  number of items to replace is not a multiple of replacement length
  
> traceback()
2: saver.fit(x, x.est, do.fast, sf, scale.sf, pred.genes, pred.cells, 
       null.model, ngenes = nrow(x), ncells = ncol(x), gene.names, 
       cell.names)
1: saver(edgeR::cpm(counts(sce4_6.25)), size.factor = 1)
-->

```{r}
CPM_SAVER_100 <- runPCA(sce4_qc, exprs_values =    "SAVER_CPM", ncomponents = 2)
CPM_SAVER_50 <- runPCA(sce4_50 ,exprs_values =     "SAVER_CPM", ncomponents = 2)
CPM_SAVER_25 <- runPCA(sce4_25, exprs_values =     "SAVER_CPM", ncomponents = 2)
CPM_SAVER_12.5 <- runPCA(sce4_12.5, exprs_values = "SAVER_CPM", ncomponents = 2)
CPM_SAVER_6.25 <- runPCA(sce4_6.25, exprs_values = "SAVER_CPM", ncomponents = 2)

PCACPM_SAVER_100 <- plotPCASCE(CPM_SAVER_100, colour_by = "cell_line", exprs_values = "SAVER_CPM", ncomponents = 2) + ggtitle("1")+ theme(legend.position="none")
PCACPM_SAVER_50 <- plotPCASCE(CPM_SAVER_50, colour_by = "cell_line",  exprs_values = "SAVER_CPM", ncomponents = 2) + ggtitle("0.5")+ theme(legend.position="none")
PCACPM_SAVER_25 <- plotPCASCE(CPM_SAVER_25, colour_by = "cell_line", exprs_values = "SAVER_CPM", ncomponents = 2) + ggtitle("0.25")+ theme(legend.position="none")
PCACPM_SAVER_12.5 <- plotPCASCE(CPM_SAVER_12.5, colour_by = "cell_line",  exprs_values = "SAVER_CPM",ncomponents = 2) + ggtitle("0.125")+ theme(legend.position="none")
PCACPM_SAVER_6.25 <- plotPCASCE(CPM_SAVER_6.25, colour_by = "cell_line",  exprs_values = "SAVER_CPM",ncomponents = 2) + ggtitle("0.0625")+ theme(legend.position="none")
multiplot(PCACPM_SAVER_100, PCACPM_SAVER_50, PCACPM_SAVER_25, PCACPM_SAVER_12.5, PCACPM_SAVER_6.25, cols = 3)
```

```{r}
sil_CPM_SAVER100 <- calcSilhouette(CPM_SAVER_100, "CPM_SAVER_100")
sil_CPM_SAVER50 <- calcSilhouette(CPM_SAVER_50, "CPM_SAVER_50")
sil_CPM_SAVER25 <- calcSilhouette(CPM_SAVER_25, "CPM_SAVER_25")
sil_CPM_SAVER12.5 <- calcSilhouette(CPM_SAVER_12.5, "CPM_SAVER_12.5")
sil_CPM_SAVER6.25 <- calcSilhouette(CPM_SAVER_6.25, "CPM_SAVER_6.25")

sil_CPM_SAVER <- rbind(sil_CPM_SAVER100, sil_CPM_SAVER50, sil_CPM_SAVER25, sil_CPM_SAVER12.5, sil_CPM_SAVER6.25)
ggplot(sil_CPM_SAVER, aes(x = method, y = sil_width, fill = factor(cluster))) + geom_boxplot() + theme_bw()
ggplot(sil_CPM_SAVER, aes(x = method, y = sil_width, fill = method)) + geom_boxplot() + theme_bw()
```

## results intergration

```{r}
med <- c()
ave <- c()
met <- c()
for( i in unique(sil_scran$method)){
  med <- c(med, median(sil_scran[sil_scran$method == i,"sil_width"]))
  ave <- c(ave, mean(sil_scran[sil_scran$method == i,"sil_width"]))
  met <- c(met, i)
}
# for( i in unique(sil_linnorm$method)){
#   med <- c(med, median(sil_linnorm[sil_linnorm$method == i,"sil_width"]))
#   ave <- c(ave, mean(sil_linnorm[sil_linnorm$method == i,"sil_width"]))
#   met <- c(met, i)
# }
for( i in unique(sil_scran_DrImpute$method)){
  med <- c(med, median(sil_scran_DrImpute[sil_scran_DrImpute$method == i,"sil_width"]))
  ave <- c(ave, mean(sil_scran_DrImpute[sil_scran_DrImpute$method == i,"sil_width"]))
  met <- c(met, i)
}
# for( i in unique(sil_linnorm_DrImpute$method)){
#   med <- c(med, median(sil_linnorm_DrImpute[sil_linnorm_DrImpute$method == i,"sil_width"]))
#   ave <- c(ave, mean(sil_linnorm_DrImpute[sil_linnorm_DrImpute$method == i,"sil_width"]))
#   met <- c(met, i)
# }
for( i in unique(sil_CPM$method)){
  med <- c(med, median(sil_CPM[sil_CPM$method == i,"sil_width"]))
  ave <- c(ave, mean(sil_CPM[sil_CPM$method == i,"sil_width"]))
  met <- c(met, i)
}
for( i in unique(sil_CPM_DrImpute$method)){
  med <- c(med, median(sil_CPM_DrImpute[sil_CPM_DrImpute$method == i,"sil_width"]))
  ave <- c(ave, mean(sil_CPM_DrImpute[sil_CPM_DrImpute$method == i,"sil_width"]))
  met <- c(met, i)
}
for( i in unique(sil_scran_SAVER$method)){
  med <- c(med, median(sil_scran_SAVER[sil_scran_SAVER$method == i,"sil_width"]))
  ave <- c(ave, mean(sil_scran_SAVER[sil_scran_SAVER$method == i,"sil_width"]))
  met <- c(met, i)
}
for( i in unique(sil_CPM_SAVER$method)){
  med <- c(med, median(sil_CPM_SAVER[sil_CPM_SAVER$method == i,"sil_width"]))
  ave <- c(ave, mean(sil_CPM_SAVER[sil_CPM_SAVER$method == i,"sil_width"]))
  met <- c(met, i)
}

library(stringr)
# prop <- sub("linnorm_","",met)
# prop <- sub("scran_", "", prop)
# prop <- sub("DrImpute_", "", prop)
# prop <- sub("CPM_", "", prop)
prop <- str_extract_all(met, "[0-9]+(.+[0-9]+)?", simplify = TRUE)
table(prop)
cell_number <- ceiling(as.numeric(c(prop)) * 110 / 100)
method <- c(str_extract_all(met, "[A-Za-z]+(_+[A-Za-z]+)?", simplify=TRUE))
table(method)
sil_ds <- data.frame(method, prop, median = med, mean = ave, cell_number)
# dim(sil_ds)
```

### heatmap

```{r}
pdf("benchmark/thesis/impute.pdf", height = 4)
# ggplot(sil_ds, aes(method, factor(cell_number))) + geom_tile(aes(fill = median), colour = "white") + scale_fill_viridis(direction = -1) + ggtitle("median silhouette width") + labs(x = "methods", y = "H1975 cell number")+ geom_text(aes(label=round(median, 3)), colour = "white") 
ggplot(sil_ds, aes(method, factor(cell_number))) + geom_tile(aes(fill = mean), colour = "white") + scale_fill_viridis(name="mean\nsilhouette\nwidth", direction = -1)  + labs(x = "methods", y = "H1975 cell number")+ geom_text(aes(label=round(mean, 3)), colour = "white") + theme(axis.text.x = element_text(angle = 30, hjust = 1),text = element_text(size=20))
dev.off()
```

```{r}
sil_imp_comp <- rbind(sil_CPM100, sil_CPM_DrImpute100, sil_linnorm100, sil_linnorm_DrImpute100, sil_scran100, sil_scran_DrImpute100)
head(sil_imp_comp)
norm <- (str_extract_all(sil_imp_comp$method, "[A-Za-z]+", simplify = TRUE))
sil_imp_comp$norm <- norm[,1]
sil_imp_comp$impu <- norm[,2]

# head(sil_imp_comp)
ggplot(sil_imp_comp, aes(norm, sil_width, fill=impu)) + geom_boxplot() + theme_bw() + ggtitle("before / after imputation") + labs(x = "normalization methods", y = "silhouette width")
```

#downsample of all cell

```{r}
sce4_qc_50 <- subsample(sce4_qc)
table(sce4_qc_50$cell_line)
sce4_qc_25 <- subsample(sce4_qc_50)
table(sce4_qc_25$cell_line)
sce4_qc_12.5 <- subsample(sce4_qc_25)
table(sce4_qc_12.5$cell_line)
sce4_qc_6.25 <- subsample(sce4_qc_12.5)
table(sce4_qc_6.25$cell_line)
```

```{r}
sce4_qc_50 <- computeSumFactors(sce4_qc_50)
sce4_qc_50 <- normalize(sce4_qc_50)
assay(sce4_qc_50, "scran") <- logcounts(sce4_qc_50)
sce4_qc_25 <- computeSumFactors(sce4_qc_25)
sce4_qc_25 <- normalize(sce4_qc_25)
assay(sce4_qc_25, "scran") <- logcounts(sce4_qc_25)
sce4_qc_12.5 <- computeSumFactors(sce4_qc_12.5)
sce4_qc_12.5 <- normalize(sce4_qc_12.5)
assay(sce4_qc_12.5, "scran") <- logcounts(sce4_qc_12.5)
# sce4_qc_6.25 <- computeSumFactors(sce4_qc_6.25)
# sce4_qc_6.25 <- normalize(sce4_qc_6.25)
# assay(sce4_qc_6.25, "scran") <- logcounts(sce4_qc_6.25)
```

```{r}
scran_all100 <- runPCA(sce4_qc, exprs_values = "scran", ncomponents = 2)
scran_all50 <- runPCA(sce4_qc_50 ,exprs_values = "scran", ncomponents = 2)
scran_all25 <- runPCA(sce4_qc_25, exprs_values = "scran", ncomponents = 2)
scran_all12.5 <- runPCA(sce4_qc_12.5, exprs_values = "scran", ncomponents = 2)
# scran_all6.25 <- runPCA(sce4_6.25, exprs_values = "scran_DrImpute", ncomponents = 2)

PCAscran_all100 <- plotPCASCE(scran_all100, colour_by = "cell_line", exprs_values = "scran", ncomponents = 2) + ggtitle("1")+ theme(legend.position="none")
PCAscran_all50 <- plotPCASCE(scran_all50, colour_by = "cell_line",  exprs_values = "scran", ncomponents = 2) + ggtitle("0.5")+ theme(legend.position="none")
PCAscran_all25 <- plotPCASCE(scran_all25, colour_by = "cell_line", exprs_values = "scran", ncomponents = 2) + ggtitle("0.25")+ theme(legend.position="none")
PCAscran_all12.5 <- plotPCASCE(scran_all12.5, colour_by = "cell_line",  exprs_values = "scran",ncomponents = 2) + ggtitle("0.125")+ theme(legend.position="none")
# PCAscran_DrImpute_6.25 <- plotPCASCE(scran_DrImpute_6.25, colour_by = "cell_line",  exprs_values = "scran_DrImpute",ncomponents = 2) + ggtitle("0.0625")+ theme(legend.position="none")
pdf("benchmark/downsample_all.pdf", height = 4)
multiplot(PCAscran_all100, PCAscran_all50, PCAscran_all25, PCAscran_all12.5, cols = 3)
dev.off()
```

seems not getting worse...
```{r}
sil100 <- calcSilhouette(scran_all100, "100")
sil50 <- calcSilhouette(scran_all50, "50")
sil25 <- calcSilhouette(scran_all25, "25")
sil12.5 <- calcSilhouette(scran_all12.5, "12.5")
# sil6.25 <- calcSilhouette(CPM_6.25, "CPM_6.25")
sil_scran_all <- rbind(sil100,sil50,sil25,sil12.5)
ggplot(sil_scran_all, aes(method, sil_width, fill = method)) + geom_violin() + theme_bw()
```

# F
Function for ANOVA and return F-statistic
```{r}
calculateF <- function(SCE, n=1){
  data <- cbind(reducedDim(SCE), colData(SCE))
  g <- lm(data[,n]~data[,"cell_line"])
  return(anova(g)$F[1])
}
```

Analysis
```{r}
f <- sapply(c(PCA1, PCA2, PCA3, PCA4, PCA5, PCA6, PCA8, PCA9, PCA10, PCA11, PCA12, PCA13, PCA14), function(x){calculateF(x)}, simplify = TRUE)
f <- data.frame(f = f, method = c("raw count", "CPM", "scran", "SCnorm", "TMM", "DESeq", "kNN", "BASiCS", "scone", "scran+DrImpute", "scran+SAVER", "Linnorm", "zinbwave"))
```

```{r}
ggplot(f, aes(x = reorder(method,f), y = f, fill=reorder(method,f))) + geom_bar(stat="identity")+ theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + theme(legend.position = "none") + labs(x="method", y="F-statistic")
```


```{r}
f2 <- sapply(c(PCA1, PCA2, PCA3, PCA4, PCA5, PCA6, PCA8, PCA9, PCA10, PCA11, PCA12, PCA13, PCA14), function(x){calculateF(x, 2)}, simplify = TRUE)
f2 <- data.frame(f = f2, method = c("raw count", "CPM", "scran", "SCnorm", "TMM", "DESeq", "kNN", "BASiCS", "scone", "scran+DrImpute", "scran+SAVER", "Linnorm", "zinbwave"))
```

```{r}
ggplot(f2, aes(x = reorder(method,f), y = f, fill=reorder(method,f))) + geom_bar(stat="identity")+ theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + theme(legend.position = "none") + labs(x="method", y="F-statistic")
```

```{r}
write.csv(f, "F/sc_1.csv")
write.csv(f2, "F/sc_2.csv")
```

# F for kNN
```{r}
fk1 <- sapply(c(k1, k1_50, k1_25, k1_12.5, k1_6.25, k3, k3_50, k3_25, k3_12.5, k3_6.25, k7, k7_50, k7_25, k7_12.5, k7_6.25, k15, k15_50, k15_25, k15_12.5, k15_6.25, k31, k31_50, k31_25, k31_12.5, k31_6.25, k63, k63_50, k63_25, k63_12.5, k63_6.25, k127, k127_50, k127_25, k127_12.5, k127_6.25), function(x){calculateF(x)})
fk2 <- sapply(c(k1, k1_50, k1_25, k1_12.5, k1_6.25, k3, k3_50, k3_25, k3_12.5, k3_6.25, k7, k7_50, k7_25, k7_12.5, k7_6.25, k15, k15_50, k15_25, k15_12.5, k15_6.25, k31, k31_50, k31_25, k31_12.5, k31_6.25, k63, k63_50, k63_25, k63_12.5, k63_6.25, k127, k127_50, k127_25, k127_12.5, k127_6.25), function(x){calculateF(x, 2)})
fk <- fk1 + fk2
fk <- data.frame(F = fk, k_value = c(rep(1, 5),rep(3, 5), rep(7, 5), rep(15, 5), rep(31, 5), rep(63, 5), rep(127, 5)), H1975_prop = rep(c(100, 50, 25, 12.5, 6.25), 7))
fk$cell_number <- ceiling(fk$H1975_prop * 110 / 100)
```


```{r}
plot_medsil <- ggplot(sil_knn_mid, aes(factor(k_value, levels=unique(sil_knn_mid$k_value)), factor(cell_number)))+ geom_tile(aes(fill = median_sil), colour = "white") + ggtitle("A. Median silhouette width")+scale_fill_viridis(direction = -1) + labs(x = "k value", y = "H1975 cell number") +geom_text(aes(label=round(median_sil,3)), colour="white")
plot_f <- ggplot(fk, aes(factor(k_value, levels=unique(fk$k_value)), factor(cell_number)))+ geom_tile(aes(fill = F), colour = "white") + ggtitle("B. F-statistic")+scale_fill_viridis(direction = -1, option="magma")+ labs(x = "k value", y = "H1975 cell number")+geom_text(aes(label=round(F,0)), colour="gray40")
PCA_k7 <- plotPCASCE(k7, colour_by = "cell_line", exprs_values = "knn7", ncomponents = 2) + ggtitle("C. k = 7, 110 H1975 cells")+ theme(legend.position="none")+ scale_fill_manual(values = c("#FF0000", "#00FF00", "#0000FF"), limits = c("H1975", "H2228", "HCC827"))
PCA_k127 <- plotPCASCE(k127, colour_by = "cell_line", exprs_values = "knn127", ncomponents = 2) + ggtitle("D. k = 127, 110 H1975 cells")+ theme(legend.position="none")+ scale_fill_manual(values = c("#FF0000", "#00FF00", "#0000FF"), limits = c("H1975", "H2228", "HCC827"))
PCA_k7_25 <- plotPCASCE(k7_25, colour_by = "cell_line", exprs_values = "knn7", ncomponents = 2) + ggtitle("E. k = 7, 28 H1975 cells")+ theme(legend.position="none")+ scale_fill_manual(values = c("#FF0000", "#00FF00", "#0000FF"), limits = c("H1975", "H2228", "HCC827"))
PCA_k127_25 <- plotPCASCE(k127_25, colour_by = "cell_line", exprs_values = "knn127", ncomponents = 2) + ggtitle("F. k = 127, 28 H1975 cells")+ theme(legend.position="none")+ scale_fill_manual(values = c("#FF0000", "#00FF00", "#0000FF"), limits = c("H1975", "H2228", "HCC827"))
pdf("benchmark/thesis/knn.pdf", height = 12)
multiplot(plot_medsil, plot_f, PCA_k7, PCA_k127,PCA_k7_25, PCA_k127_25, layout=matrix(c(rep(1, 2), rep(2, 2), 3, 4, 5, 6), nrow=4, byrow=TRUE))
dev.off()
```



# session info

```{r}
sessionInfo()
```

# save
```{r}

save(sce4_qc, file = "benchmark_SCE_sc.RData")
write.csv(sil_all, "benchmark/sc_sil_all.csv")
save.image("benchmark_time120418.RData")
```

